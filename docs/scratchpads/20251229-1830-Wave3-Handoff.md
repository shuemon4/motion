# Wave 3 Backend Implementation - Handoff Prompt

**Date**: 2025-12-29 18:30
**For**: Fresh Claude Code session
**Status**: Ready for execution

---

## Quick Start

Copy and paste this prompt into a fresh Claude Code session:

```
Read and execute the implementation plan at `docs/plans/20251229-1800-Wave3-Backend-Implementation.md`

The plan implements Wave 3A (Mask Editor API) and Wave 3B (Notification System).

Key files to modify:
1. `src/webu_json.hpp` - Add 3 method declarations
2. `src/webu_json.cpp` - Add helper functions and 3 API methods
3. `src/webu_ans.cpp` - Add routing for mask endpoints
4. Create `data/scripts/motion-notify.sh`
5. Create `data/scripts/notify.conf.example`

After implementing, build on Pi:
- rsync code to admin@192.168.1.176:~/motion-motioneye/
- ssh and run: cd ~/motion-motioneye && make -j4
- Test endpoints: curl http://192.168.1.176:7999/1/api/mask/motion

Critical patterns to follow:
- Use existing escstr() for JSON string escaping
- Use myfopen/myfclose wrappers
- Add CSRF validation for POST/DELETE
- Lock app->mutex_post when modifying config
```

---

## Context Summary

### Project

Motion-MotionEye: C++ motion detection daemon with React UI for Raspberry Pi.

### What Was Done

1. Researched existing codebase patterns
2. Created detailed implementation plan with complete code
3. Decision: Masks auto-stored in `target_dir/cam{id}_{type}.pgm`

### What Needs to Be Done

**Wave 3A - Mask API (~200 LOC)**

Add to `src/webu_json.hpp`:
```cpp
void api_mask_get();
void api_mask_post();
void api_mask_delete();
```

Add to `src/webu_json.cpp`:
- `fill_polygon()` - Scanline fill helper
- `build_mask_path()` - Generate mask path
- `api_mask_get()` - Return mask info
- `api_mask_post()` - Parse polygons, create PGM
- `api_mask_delete()` - Remove mask file

Add routing to `src/webu_ans.cpp`:
- GET/POST/DELETE for `/{camId}/api/mask/{type}`

**Wave 3B - Notification Script**

Create `data/scripts/motion-notify.sh` - Email/Telegram/Webhook dispatcher

---

## Files to Reference

| Purpose | File |
|---------|------|
| Implementation plan | `docs/plans/20251229-1800-Wave3-Backend-Implementation.md` |
| Existing JSON API | `src/webu_json.cpp` |
| Routing patterns | `src/webu_ans.cpp` |
| PGM handling | `src/picture.cpp` (lines 530-636) |
| JSON parsing | `src/json_parse.cpp` |

---

## Build & Test Commands

```bash
# Sync to Pi
rsync -avz --exclude='.git' --exclude='node_modules' \
  /Users/tshuey/Documents/GitHub/motion-motioneye/ \
  admin@192.168.1.176:~/motion-motioneye/

# Build on Pi
ssh admin@192.168.1.176 "cd ~/motion-motioneye && make -j4"

# Install and restart
ssh admin@192.168.1.176 "cd ~/motion-motioneye && sudo make install && sudo systemctl restart motion"

# Test GET mask
curl http://192.168.1.176:7999/1/api/mask/motion

# Get CSRF token for POST/DELETE
curl http://192.168.1.176:7999/0/api/config | jq .csrf_token
```

---

## Critical Notes

1. **CPU Efficiency**: Integer-only math in polygon fill, no floating point
2. **Security**: CSRF required for POST/DELETE, path traversal checks
3. **Thread Safety**: Lock `app->mutex_post` when modifying config
4. **Existing Patterns**: Follow `api_delete_picture()` as template
5. **PGM Format**: P5 binary, header + raw bytes, no compression
