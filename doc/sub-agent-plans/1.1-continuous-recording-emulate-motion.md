# Sub-Agent Plan: 1.1 Fix Continuous Recording (emulate_motion)

**Parent Plan**: `doc/plans/20260112-1500-ui-improvement-implementation.md`
**Priority**: CRITICAL (feature doesn't work as advertised)
**Estimated Effort**: 1 hour

---

## Research Findings

### The Bug

**Problem**: UI shows "Continuous Recording" option but doesn't enable the backend's `emulate_motion` parameter. Users expect 24/7 recording but only get motion-triggered recording with a different video overlay.

### Backend Parameter Details

**File**: `src/conf.cpp:113, 660`

```cpp
// conf.cpp:113
{"emulate_motion", PARM_TYP_BOOL, PARM_CAT_05, PARM_LEVEL_LIMITED, true},

// conf.cpp:660
if (name == "emulate_motion") return edit_generic_bool(emulate_motion, parm, pact, false);
```

**Key Facts**:
- Parameter name: `emulate_motion`
- Type: PARM_TYP_BOOL
- Hot-reload: `true` (takes effect immediately)
- Default: `false`
- Category: PARM_CAT_05 (Motion Detection)

### How emulate_motion Works

**File**: `src/camera.cpp:1219, 1728`

```cpp
// camera.cpp:1219
if (cfg->emulate_motion) {
    MOTION_LOG(INF, TYPE_ALL, NO_ERRNO, _("Emulating motion"));
}

// camera.cpp:1728
if ((cfg->emulate_motion || event_user) && (startup_frames == 0)) {
    // Triggers motion event even without actual motion detected
}
```

When `emulate_motion=true`:
- Every frame is treated as if motion was detected
- Recording happens continuously regardless of actual motion
- Events are continuously triggered

### Current Frontend State (BUG)

**File**: `frontend/src/utils/translations.ts:130-134`

```typescript
export const RECORDING_MODE_MAP = {
  'motion-triggered': { movie_output: true, movie_output_motion: true },
  continuous: { movie_output: true, movie_output_motion: false },  // BUG: Missing emulate_motion!
  off: { movie_output: false },
} as const;
```

The `continuous` mode sets:
- `movie_output: true` ✓
- `movie_output_motion: false` ✓
- `emulate_motion: true` ❌ **MISSING**

**File**: `frontend/src/components/settings/MovieSettings.tsx:29-37`

```typescript
const handleRecordingModeChange = (mode: string) => {
  setSelectedMode(mode);
  const motionParams = recordingModeToMotion(mode);

  // Apply the mode's parameter changes
  onChange('movie_output', motionParams.movie_output);
  if (motionParams.movie_output_motion !== undefined) {
    onChange('movie_output_motion', motionParams.movie_output_motion);
  }
  // BUG: emulate_motion is never set!
};
```

### What "Continuous Recording" Currently Does (Wrong)

1. Sets `movie_output=true` - enables movie recording
2. Sets `movie_output_motion=false` - disables motion-type overlay
3. Does NOT set `emulate_motion=true` - recording still only happens on motion events

**Result**: Videos are created only during motion events, but without motion-type overlay. User sees "Continuous Recording" but doesn't get continuous recording.

### What "Continuous Recording" Should Do (Correct)

1. Sets `movie_output=true` - enables movie recording
2. Sets `movie_output_motion=false` - disables motion-type overlay (optional, same behavior)
3. Sets `emulate_motion=true` - **triggers continuous recording**

---

## Implementation Tasks

### Task 1: Update RECORDING_MODE_MAP Type

**File**: `frontend/src/utils/translations.ts`

Update the interface to support emulate_motion:

```typescript
// Around line 128, before RECORDING_MODE_MAP
export interface RecordingMode {
  movie_output: boolean;
  movie_output_motion?: boolean;
  emulate_motion?: boolean;
}

export const RECORDING_MODE_MAP: Record<string, RecordingMode> = {
  'motion-triggered': { movie_output: true, movie_output_motion: true, emulate_motion: false },
  continuous: { movie_output: true, movie_output_motion: false, emulate_motion: true },
  off: { movie_output: false, emulate_motion: false },
};
```

### Task 2: Update recordingModeToMotion Function

**File**: `frontend/src/utils/translations.ts`

Update the return type and function (around line 150):

```typescript
/**
 * Convert recording mode to Motion parameters
 */
export function recordingModeToMotion(
  mode: string
): RecordingMode {
  return (
    RECORDING_MODE_MAP[mode] || { movie_output: false, emulate_motion: false }
  );
}
```

### Task 3: Update motionToRecordingMode Function

**File**: `frontend/src/utils/translations.ts`

Update to consider emulate_motion when determining mode (around line 139):

```typescript
/**
 * Determine recording mode from Motion parameters
 */
export function motionToRecordingMode(
  movieOutput: boolean,
  movieOutputMotion: boolean,
  emulateMotion: boolean = false
): string {
  if (!movieOutput) return 'off';
  if (emulateMotion) return 'continuous';
  return movieOutputMotion ? 'motion-triggered' : 'motion-triggered';
}
```

### Task 4: Update MovieSettings.tsx to Handle emulate_motion

**File**: `frontend/src/components/settings/MovieSettings.tsx`

1. Read emulate_motion from config:

```typescript
// Around line 23-25
const movieOutput = getValue('movie_output', false) as boolean;
const movieOutputMotion = getValue('movie_output_motion', true) as boolean;
const emulateMotion = getValue('emulate_motion', false) as boolean;
const currentMode = motionToRecordingMode(movieOutput, movieOutputMotion, emulateMotion);
```

2. Update handleRecordingModeChange to set emulate_motion:

```typescript
const handleRecordingModeChange = (mode: string) => {
  setSelectedMode(mode);
  const motionParams = recordingModeToMotion(mode);

  // Apply the mode's parameter changes
  onChange('movie_output', motionParams.movie_output);
  if (motionParams.movie_output_motion !== undefined) {
    onChange('movie_output_motion', motionParams.movie_output_motion);
  }
  // Set emulate_motion for continuous recording
  if (motionParams.emulate_motion !== undefined) {
    onChange('emulate_motion', motionParams.emulate_motion);
  }
};
```

3. Update debug display:

```typescript
{/* Show conversion explanation */}
<div className="text-xs text-gray-400 bg-surface-elevated p-3 rounded">
  <strong>Current settings:</strong> movie_output={String(movieOutput)}
  {movieOutput && `, movie_output_motion=${String(movieOutputMotion)}`}
  {emulateMotion && `, emulate_motion=true`}
</div>
```

### Task 5: Add emulate_motion to DIRECT_MAPPINGS

**File**: `frontend/src/utils/parameterMappings.ts`

Add to the Movies section (after movie_encoder_preset):

```typescript
  // Movies
  movie_output: 'movie_output',
  movie_output_motion: 'movie_output_motion',
  movie_quality: 'movie_quality',
  movie_filename: 'movie_filename',
  movie_max_time: 'movie_max_time',
  movie_passthrough: 'movie_passthrough',
  movie_container: 'movie_container',
  movie_encoder_preset: 'movie_encoder_preset',
  emulate_motion: 'emulate_motion',  // ADD THIS
```

### Task 6: Update Continuous Recording Warning

**File**: `frontend/src/components/settings/MovieSettings.tsx`

Update the existing warning (around line 191-196) to be more informative:

```typescript
{selectedMode === 'continuous' && (
  <div className="text-xs text-yellow-200 bg-yellow-600/10 border border-yellow-600/30 p-3 rounded">
    <strong>Continuous Recording:</strong> Camera will record 24/7 regardless of motion.
    This uses significant CPU for encoding. Consider:
    <ul className="list-disc ml-4 mt-1">
      <li>Use "Ultrafast" encoder preset to reduce CPU by ~30%</li>
      <li>Use Pi 4 hardware encoding (h264_v4l2m2m) for ~10% CPU</li>
      <li>Enable passthrough mode if source is already H.264</li>
    </ul>
  </div>
)}
```

---

## Verification Steps

### 1. UI Verification

1. Open Settings → Movie Settings
2. Select "Continuous Recording"
3. Check debug display shows `emulate_motion=true`
4. Select "Motion Triggered"
5. Check debug display shows NO emulate_motion or `emulate_motion=false`
6. Select "Off"
7. Check `movie_output=false`

### 2. API Verification

1. Select "Continuous Recording"
2. Open browser dev tools → Network tab
3. Verify API call includes `emulate_motion=true` (or `on`)
4. Check Motion logs for "Emulating motion" message

### 3. Functional Verification (On Pi)

```bash
# Enable continuous recording via UI, then check logs
ssh admin@192.168.1.176 "sudo journalctl -u motion -n 50 --no-pager | grep -i emulat"

# Should see:
# [INF] Emulating motion

# Verify continuous video creation
ssh admin@192.168.1.176 "ls -la /var/lib/motion/*.mkv | tail -5"
# Should see new files being created every movie_max_time seconds
```

### 4. Edge Case: Switching Modes

1. Enable "Continuous Recording"
2. Verify recording starts
3. Switch to "Motion Triggered"
4. Verify `emulate_motion=false` sent
5. Verify recording stops (if no motion)
6. Create motion
7. Verify recording starts only during motion

---

## Files Modified

| File | Change |
|------|--------|
| `frontend/src/utils/translations.ts` | Add emulate_motion to RECORDING_MODE_MAP, update functions |
| `frontend/src/utils/parameterMappings.ts` | Add emulate_motion to DIRECT_MAPPINGS |
| `frontend/src/components/settings/MovieSettings.tsx` | Handle emulate_motion in state and onChange |

---

## Dependencies

- None (standalone fix)
- Items 1.2, 1.3, 1.5, 1.6 are already implemented

---

## Notes

- `emulate_motion` has hot-reload = true, so changes take effect immediately
- When continuous mode is disabled, explicitly set `emulate_motion=false`
- The motion detection still runs (for overlay purposes) but every frame triggers an event
- This is a critical bug fix - the feature literally doesn't work as advertised
