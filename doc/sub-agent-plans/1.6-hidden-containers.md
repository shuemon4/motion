# Sub-Agent Plan: 1.6 Expose Hidden Container Formats

**Parent Plan**: `doc/plans/20260112-1500-ui-improvement-implementation.md`
**Priority**: Medium (format flexibility)
**Estimated Effort**: 30 minutes

---

## Research Findings

### Backend Container Support

**File**: `src/movie.cpp:148-182`

The backend supports these container formats:

| Container Value | File Extension | Default Codec | Notes |
|-----------------|---------------|---------------|-------|
| `mov` | .mov | H.264 (AV_CODEC_ID_H264) | Apple QuickTime format |
| `webm` | .webm | VP8 (AV_CODEC_ID_VP8) | Web-optimized format |
| `mp4` | .mp4 | H.264 (AV_CODEC_ID_H264) | Most compatible |
| `mkv` | .mkv | H.264 (AV_CODEC_ID_H264) | Flexible, good for streaming |
| `hevc` | .mp4 | HEVC (AV_CODEC_ID_HEVC) | H.265, smaller files, high CPU |

### Container Handling Code

```cpp
// movie.cpp:148-182
if (container == "mov") {
    oc->oformat = av_guess_format("mov", nullptr, nullptr);
    full_nm += ".mov";
    file_nm += ".mov";
    oc->video_codec_id = AV_CODEC_ID_H264;
}

if (container == "webm") {
    oc->oformat = av_guess_format("webm", nullptr, nullptr);
    full_nm += ".webm";
    file_nm += ".webm";
    oc->video_codec_id = AV_CODEC_ID_VP8;
}

// ... mp4, mkv ...

if (container == "hevc") {
    oc->video_codec_id = AV_CODEC_ID_HEVC;
    oc->oformat = av_guess_format("mp4", nullptr, nullptr);
    full_nm += ".mp4";
    file_nm += ".mp4";
}
```

### Backend Test Mode

**File**: `src/movie.cpp:1404-1418`

Backend test mode cycles through all containers, confirming they all work:

```cpp
if (cam->cfg->movie_container == "test") {
    codenbr = cam->event_curr_nbr % 6;
    if (codenbr == 1) container = "mov";
    else if (codenbr == 2) container = "webm";
    else if (codenbr == 3) container = "mp4";
    else if (codenbr == 4) container = "mkv";
    else if (codenbr == 5) container = "hevc";
    else container = "mp4";
}
```

### Config Validation (Incomplete)

**File**: `src/conf.cpp:860`

```cpp
static const std::vector<std::string> movie_container_values = {"mkv","mp4","3gp"};
```

Note: conf.cpp validation is incomplete - only lists 3 containers. But movie.cpp accepts all 5+ formats. The validation just returns false for unlisted values but doesn't reject them.

### Current Frontend State

**File**: `frontend/src/utils/parameterMappings.ts:151-155`

```typescript
export const MOVIE_CONTAINERS = [
  { value: 'mkv', label: 'MKV (Matroska)' },
  { value: 'mp4', label: 'MP4' },
  { value: '3gp', label: '3GP' },
];
```

Missing: mov, webm, hevc

---

## Implementation Tasks

### Note: Integration with Task 1.3

Task 1.3 (Extended Codec Syntax) already expands MOVIE_CONTAINERS significantly. This task ensures the basic hidden containers are included even if 1.3 is not implemented.

If Task 1.3 is done first, verify these containers are already included. If not, add them.

### Task 1: Add Hidden Containers to MOVIE_CONTAINERS

**File**: `frontend/src/utils/parameterMappings.ts`

If Task 1.3 is NOT done, replace MOVIE_CONTAINERS:

```typescript
// Movie container formats
export const MOVIE_CONTAINERS = [
  { value: 'mkv', label: 'MKV (Matroska)' },
  { value: 'mp4', label: 'MP4' },
  { value: 'mov', label: 'MOV (QuickTime)' },
  { value: '3gp', label: '3GP (Mobile)' },
  { value: 'webm', label: 'WebM (VP8)' },
  { value: 'hevc', label: 'HEVC/H.265 (high CPU)' },
];
```

If Task 1.3 IS done, verify `mov`, `webm`, and `hevc` are in the array from that task.

### Task 2: Add Warning for HEVC

**File**: `frontend/src/components/settings/MovieSettings.tsx`

Add warning when HEVC selected (if not already done in 1.3):

```typescript
const containerValue = String(getValue('movie_container', 'mp4'));

{containerValue === 'hevc' && (
  <div className="text-xs text-amber-400 bg-amber-950/30 p-3 rounded mt-2">
    <strong>High CPU Warning:</strong> HEVC/H.265 uses software encoding at
    80-100% CPU on Raspberry Pi. Files are smaller but recording may cause
    thermal throttling. Not recommended for continuous recording.
  </div>
)}
```

### Task 3: Add WebM Info (Optional)

```typescript
{containerValue === 'webm' && (
  <div className="text-xs text-blue-400 bg-blue-950/30 p-3 rounded mt-2">
    <strong>WebM Format:</strong> Uses VP8 codec, optimized for web streaming.
    Good browser compatibility. Encoder preset setting does not apply to VP8.
  </div>
)}
```

---

## Container Format Details

### MOV (QuickTime)
- **Use case**: Apple ecosystem, Final Cut Pro editing
- **Codec**: H.264 (same as MP4)
- **CPU**: Same as MP4
- **Note**: Less compatible than MP4 on non-Apple devices

### WebM
- **Use case**: Web embedding, HTML5 video
- **Codec**: VP8 (not H.264)
- **CPU**: Moderate (VP8 encoder is reasonably efficient)
- **Note**: Encoder preset doesn't apply (VP8 has different options)

### HEVC (H.265)
- **Use case**: Maximum compression, smallest file size
- **Codec**: HEVC/H.265
- **CPU**: Very high (80-100% on software encoding)
- **Note**: No hardware encoder on Pi 4 or Pi 5 for HEVC
- **Warning**: Not recommended for continuous recording

---

## Verification Steps

1. **All formats visible**:
   - Open Settings â†’ Movies section
   - Open Container dropdown
   - Verify all 6 formats visible: MKV, MP4, MOV, 3GP, WebM, HEVC

2. **MOV format works**:
   - Select MOV
   - Trigger recording
   - Verify .mov file created and playable

3. **WebM format works**:
   - Select WebM
   - Trigger recording
   - Verify .webm file created and playable in browser

4. **HEVC format works**:
   - Select HEVC
   - Trigger recording
   - Verify .mp4 file created with H.265 codec
   - Check CPU usage is high (~80-100%)

5. **HEVC warning displays**:
   - Select HEVC
   - Verify amber warning appears about high CPU

6. **WebM info displays** (if implemented):
   - Select WebM
   - Verify blue info box appears

---

## Files Modified

| File | Change |
|------|--------|
| `frontend/src/utils/parameterMappings.ts` | Add mov, webm, hevc to MOVIE_CONTAINERS |
| `frontend/src/components/settings/MovieSettings.tsx` | Add conditional warnings |

---

## Dependencies

- Check if Task 1.3 is completed first
- If 1.3 is done, this task may be a subset/verification only

---

## Notes

- HEVC produces smallest files but has no hardware encoder on any Pi
- WebM is great for web but not widely supported in video editors
- MOV is identical to MP4 internally but with Apple branding
- 3GP is legacy mobile format, rarely used now
- All formats use the same quality slider (movie_quality)
