# Sub-Agent Plan: 2.1 Camera Capability Detection Integration

**Parent Plan**: `doc/plans/20260112-1500-ui-improvement-implementation.md`
**Priority**: High (eliminates user confusion, major UX improvement)
**Estimated Effort**: 4-6 hours

---

## Research Findings

### Backend Already Implemented ✅

The capability discovery backend was fully implemented on 2025-12-22 (per `doc/plans/archive-motion/plans/20251222-1400-Camera-Capability-Discovery.md`).

**status.json now includes supportedControls:**
```json
{
  "cam1": {
    "name": "Camera 1",
    "supportedControls": {
      "AfMode": false,
      "LensPosition": false,
      "AfTrigger": false,
      "AfRange": false,
      "AfSpeed": false,
      "AfMetering": false,
      "ExposureTime": true,
      "ExposureValue": true,
      "AnalogueGain": true,
      "AeEnable": true,
      "AeMeteringMode": true,
      "AeConstraintMode": true,
      "AeExposureMode": true,
      "AwbEnable": true,
      "AwbMode": true,
      "AwbLocked": true,
      "ColourGains": true,
      "ColourTemperature": true,
      "Brightness": true,
      "Contrast": true,
      "Saturation": true,
      "Sharpness": true,
      "DigitalGain": true,
      "ScalerCrop": true
    }
  }
}
```

**Key capability mapping:**

| libcamera Control | UI Parameter | Show When |
|-------------------|--------------|-----------|
| `AfMode` | libcam_af_mode | `AfMode === true` |
| `LensPosition` | libcam_lens_position | `LensPosition === true` |
| `AfRange` | libcam_af_range | `AfMode === true && AfRange === true` |
| `AfSpeed` | libcam_af_speed | `AfMode === true && AfSpeed === true` |

### Current Frontend State

**File**: `frontend/src/components/settings/LibcameraSettings.tsx`

- Shows all autofocus controls unconditionally (lines 134-183)
- No capabilities prop or conditional rendering
- Current pattern: Shows AF controls based on `libcam_af_mode` value, not camera support

**File**: `frontend/src/pages/Settings.tsx`

- Passes `config`, `onChange`, `getError` to LibcameraSettings (lines 391-395)
- No status.json fetch or capabilities handling
- Camera selection is in `selectedCamera` state variable

### Existing Patterns to Follow

**File**: `frontend/src/api/queries.ts`

Uses TanStack Query pattern:
```typescript
export function useSystemStatus() {
  return useQuery({
    queryKey: queryKeys.systemStatus,
    queryFn: () => apiGet<SystemStatus>('/0/api/system/status'),
    refetchInterval: 10000,
    refetchIntervalInBackground: false,
    staleTime: 5000,
  });
}
```

**File**: `frontend/src/api/types.ts`

Type definitions pattern - add new interface for capabilities.

**File**: `frontend/src/api/client.ts`

Uses `apiGet<T>(endpoint)` for typed GET requests.

---

## Implementation Tasks

### Task 1: Add Types for Camera Capabilities

**File**: `frontend/src/api/types.ts`

Add new interfaces:

```typescript
// Camera control capabilities from supportedControls in status.json
export interface CameraCapabilities {
  // Autofocus
  AfMode?: boolean;
  LensPosition?: boolean;
  AfTrigger?: boolean;
  AfRange?: boolean;
  AfSpeed?: boolean;
  AfMetering?: boolean;

  // Exposure
  ExposureTime?: boolean;
  ExposureValue?: boolean;
  AnalogueGain?: boolean;
  AeEnable?: boolean;
  AeMeteringMode?: boolean;
  AeConstraintMode?: boolean;
  AeExposureMode?: boolean;

  // White Balance
  AwbEnable?: boolean;
  AwbMode?: boolean;
  AwbLocked?: boolean;
  ColourGains?: boolean;
  ColourTemperature?: boolean;

  // Image Controls
  Brightness?: boolean;
  Contrast?: boolean;
  Saturation?: boolean;
  Sharpness?: boolean;

  // Other
  DigitalGain?: boolean;
  ScalerCrop?: boolean;
}

// Camera status from status.json (per camera)
export interface CameraStatus {
  name: string;
  id: number;
  width: number;
  height: number;
  fps: number;
  current_time: string;
  lost_connection: boolean;
  detecting: boolean;
  pause: boolean;
  supportedControls?: CameraCapabilities;
}

// Full status.json response
export interface StatusResponse {
  version: string;
  status: {
    count: number;
    [key: string]: CameraStatus | number;  // cam1, cam2, etc. or count
  };
}
```

### Task 2: Add useCameraCapabilities Hook

**File**: `frontend/src/hooks/useCameraCapabilities.ts` (NEW)

```typescript
import { useQuery } from '@tanstack/react-query';
import { apiGet } from '@/api/client';
import type { StatusResponse, CameraCapabilities } from '@/api/types';

// Query key for cache management
export const cameraCapabilitiesKey = (cameraId: number) =>
  ['cameraCapabilities', cameraId] as const;

/**
 * Fetch camera capabilities from status.json
 * Returns supportedControls map for the specified camera
 */
export function useCameraCapabilities(cameraId: number) {
  return useQuery({
    queryKey: cameraCapabilitiesKey(cameraId),
    queryFn: async (): Promise<CameraCapabilities> => {
      const response = await apiGet<StatusResponse>('/0/status.json');

      // Find the camera in the response
      const camKey = `cam${cameraId}`;
      const cameraStatus = response.status[camKey];

      if (typeof cameraStatus === 'object' && cameraStatus !== null) {
        return cameraStatus.supportedControls || {};
      }

      // Camera not found or no capabilities
      return {};
    },
    staleTime: 60000, // Cache for 1 minute (capabilities don't change at runtime)
    retry: 1,
  });
}

// Helper functions for common capability checks
export function hasAutofocus(capabilities?: CameraCapabilities): boolean {
  return capabilities?.AfMode === true;
}

export function hasManualFocus(capabilities?: CameraCapabilities): boolean {
  return capabilities?.LensPosition === true;
}

export function hasExposureControl(capabilities?: CameraCapabilities): boolean {
  return capabilities?.ExposureTime === true;
}

export function hasAwbControl(capabilities?: CameraCapabilities): boolean {
  return capabilities?.AwbEnable === true;
}
```

### Task 3: Update LibcameraSettings Interface and Props

**File**: `frontend/src/components/settings/LibcameraSettings.tsx`

Update interface to accept capabilities:

```typescript
import type { CameraCapabilities } from '@/api/types';

export interface LibcameraSettingsProps {
  config: Record<string, { value: string | number | boolean }>;
  onChange: (param: string, value: string | number | boolean) => void;
  getError?: (param: string) => string | undefined;
  capabilities?: CameraCapabilities;  // NEW
}

export function LibcameraSettings({
  config,
  onChange,
  getError,
  capabilities  // NEW
}: LibcameraSettingsProps) {
  // ... existing code
}
```

### Task 4: Add Conditional Rendering for Autofocus Controls

**File**: `frontend/src/components/settings/LibcameraSettings.tsx`

Replace unconditional autofocus section (lines 133-183) with conditional rendering:

```typescript
{/* Autofocus Section */}
{capabilities?.AfMode ? (
  <>
    <FormSelect
      label="Autofocus Mode"
      value={String(getValue('libcam_af_mode', 0))}
      onChange={(val) => onChange('libcam_af_mode', Number(val))}
      options={AUTOFOCUS_MODES.map((mode) => ({
        value: String(mode.value),
        label: mode.label,
      }))}
      helpText="Focus control mode"
    />

    {Number(getValue('libcam_af_mode', 0)) === 0 && capabilities?.LensPosition && (
      <FormSlider
        label="Lens Position"
        value={Number(getValue('libcam_lens_position', 0))}
        onChange={(val) => onChange('libcam_lens_position', val)}
        min={0}
        max={15}
        step={0.5}
        unit=" dioptres"
        helpText="Manual focus position (0.0-15.0 dioptres)"
        error={getError?.('libcam_lens_position')}
      />
    )}

    {Number(getValue('libcam_af_mode', 0)) > 0 && (
      <>
        {capabilities?.AfRange && (
          <FormSelect
            label="Autofocus Range"
            value={String(getValue('libcam_af_range', 0))}
            onChange={(val) => onChange('libcam_af_range', Number(val))}
            options={AUTOFOCUS_RANGES.map((range) => ({
              value: String(range.value),
              label: range.label,
            }))}
            helpText="Focus range preference"
          />
        )}

        {capabilities?.AfSpeed && (
          <FormSelect
            label="Autofocus Speed"
            value={String(getValue('libcam_af_speed', 0))}
            onChange={(val) => onChange('libcam_af_speed', Number(val))}
            options={AUTOFOCUS_SPEEDS.map((speed) => ({
              value: String(speed.value),
              label: speed.label,
            }))}
            helpText="Focus adjustment speed"
          />
        )}
      </>
    )}
  </>
) : capabilities !== undefined ? (
  // Capabilities loaded but AF not supported
  <div className="text-xs text-gray-400 bg-surface-elevated p-3 rounded">
    <strong>Autofocus:</strong> Not supported on this camera.
    {capabilities?.LensPosition ? (
      <span> Manual focus (lens position) is available below.</span>
    ) : (
      <span> This camera has fixed focus.</span>
    )}
  </div>
) : null /* Still loading capabilities, don't show anything yet */}

{/* Manual Focus without Autofocus (some cameras have motorized lens but no AF) */}
{!capabilities?.AfMode && capabilities?.LensPosition && (
  <FormSlider
    label="Lens Position"
    value={Number(getValue('libcam_lens_position', 0))}
    onChange={(val) => onChange('libcam_lens_position', val)}
    min={0}
    max={15}
    step={0.5}
    unit=" dioptres"
    helpText="Manual focus position (0.0-15.0 dioptres)"
    error={getError?.('libcam_lens_position')}
  />
)}
```

### Task 5: Update Settings.tsx to Fetch and Pass Capabilities

**File**: `frontend/src/pages/Settings.tsx`

1. Add import:
```typescript
import { useCameraCapabilities } from '@/hooks/useCameraCapabilities';
```

2. Add hook call (after other hooks, around line 76):
```typescript
// Fetch camera capabilities for conditional UI rendering
const { data: capabilities } = useCameraCapabilities(Number(selectedCamera));
```

3. Update LibcameraSettings call (around line 391):
```typescript
<LibcameraSettings
  config={activeConfig}
  onChange={handleChange}
  getError={getError}
  capabilities={capabilities}
/>
```

### Task 6: Add Query Key to queries.ts

**File**: `frontend/src/api/queries.ts`

Add to queryKeys object:
```typescript
export const queryKeys = {
  config: (camId?: number) => ['config', camId] as const,
  cameras: ['cameras'] as const,
  pictures: (camId: number) => ['pictures', camId] as const,
  movies: (camId: number) => ['movies', camId] as const,
  temperature: ['temperature'] as const,
  systemStatus: ['systemStatus'] as const,
  cameraCapabilities: (camId: number) => ['cameraCapabilities', camId] as const,  // NEW
};
```

### Task 7: Add Loading State for Capabilities

**File**: `frontend/src/components/settings/LibcameraSettings.tsx`

Handle loading state gracefully:

```typescript
export function LibcameraSettings({
  config,
  onChange,
  getError,
  capabilities
}: LibcameraSettingsProps) {
  const getValue = (param: string, defaultValue: string | number | boolean = '') => {
    return config[param]?.value ?? defaultValue;
  };

  const awbEnabled = Boolean(getValue('libcam_awb_enable', false));

  // Show skeleton or minimal UI while capabilities load
  const capabilitiesLoading = capabilities === undefined;

  return (
    <FormSection
      title="libcamera Controls"
      description="Raspberry Pi camera controls (libcamera only)"
      collapsible
      defaultOpen={false}
    >
      {/* Image Controls - always show (almost all cameras support these) */}
      <FormSlider
        label="Brightness"
        // ... existing code
      />
      // ... contrast, gain

      {/* AWB - always show (widely supported) */}
      // ... existing AWB code

      {/* Autofocus - conditional based on capabilities */}
      {capabilitiesLoading ? (
        <div className="text-xs text-gray-500 p-3">
          Loading camera capabilities...
        </div>
      ) : (
        // ... conditional autofocus rendering from Task 4
      )}

      {/* Buffer Settings - always show */}
      <FormInput
        label="Buffer Count"
        // ... existing code
      />
    </FormSection>
  );
}
```

---

## Files to Create

| File | Purpose |
|------|---------|
| `frontend/src/hooks/useCameraCapabilities.ts` | Hook to fetch and cache camera capabilities |

## Files to Modify

| File | Change |
|------|--------|
| `frontend/src/api/types.ts` | Add CameraCapabilities, CameraStatus, StatusResponse types |
| `frontend/src/api/queries.ts` | Add cameraCapabilities query key |
| `frontend/src/components/settings/LibcameraSettings.tsx` | Add capabilities prop, conditional rendering |
| `frontend/src/pages/Settings.tsx` | Import hook, fetch capabilities, pass to component |

---

## Verification Steps

### 1. API Response Check

```bash
# On Pi with Motion running
curl -s http://localhost:7999/0/status.json | jq '.status.cam1.supportedControls'
```

Should return:
```json
{
  "AfMode": false,       // Pi Camera v2
  "LensPosition": false,
  "Brightness": true,
  ...
}
```

### 2. Pi Camera v2 Test (IMX219 - No Autofocus)

1. Open Settings page
2. Expand "libcamera Controls" section
3. **Should see**: "Autofocus: Not supported on this camera. This camera has fixed focus."
4. **Should NOT see**: Autofocus Mode dropdown, AF Range, AF Speed
5. **Should see**: Brightness, Contrast, Gain, AWB controls

### 3. Pi Camera v3 Test (IMX708 - Full Autofocus)

1. Open Settings page
2. Expand "libcamera Controls" section
3. **Should see**: Autofocus Mode dropdown
4. Select "Manual" mode → Should see Lens Position slider
5. Select "Continuous" mode → Should see AF Range and AF Speed dropdowns
6. **Should see**: All image controls (brightness, contrast, etc.)

### 4. Camera Switching Test

1. Have 2 cameras configured (one v2, one v3)
2. Select v2 camera → AF controls should be hidden
3. Switch to v3 camera → AF controls should appear
4. Switch back to v2 → AF controls should hide again
5. Verify no console errors during switching

### 5. Loading State Test

1. Add network delay in dev tools (slow 3G)
2. Open Settings page
3. Should see "Loading camera capabilities..." briefly
4. Then controls should render based on capabilities

### 6. Error Handling Test

1. Stop Motion daemon
2. Open Settings page
3. Should see image controls (assume supported)
4. AF section should not crash
5. Verify graceful degradation

---

## Error Handling

### Capability Fetch Failure

If status.json fetch fails:
- Log warning to console
- Show all controls (current behavior)
- Don't crash or show error to user

```typescript
export function useCameraCapabilities(cameraId: number) {
  return useQuery({
    // ...
    retry: 1,
    onError: (error) => {
      console.warn('Failed to fetch camera capabilities:', error);
      // Return empty capabilities, which means "show all controls"
    },
  });
}
```

### Camera Not Found

If camera doesn't exist in status.json:
- Return empty capabilities object
- Controls render with fallback behavior

---

## Notes

- Backend implementation is complete (`src/libcam.cpp`, `src/webu_json.cpp`)
- Capabilities are per-camera, fetched via status.json
- Capabilities don't change at runtime - cache for 1 minute is appropriate
- Always show basic controls (brightness, contrast, gain, AWB) - widely supported
- Only autofocus controls need capability checks (v2 vs v3 difference)
- Status.json is already used for system status - piggyback on existing endpoint
