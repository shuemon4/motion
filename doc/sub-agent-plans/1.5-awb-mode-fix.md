# Sub-Agent Plan: 1.5 Fix AWB Mode Values

**Parent Plan**: `doc/plans/20260112-1500-ui-improvement-implementation.md`
**Priority**: High (incorrect labels cause user confusion)
**Estimated Effort**: 15 minutes

---

## Research Findings

### Critical Issue: All AWB Labels Are Wrong

The current UI has **incorrect labels for AWB modes 1-6** and is **missing mode 7**.

### libcamera Official AWB Mode Values

Source: [libcamera controls namespace](https://libcamera.org/api-html/namespacelibcamera_1_1controls.html)

| Value | Enum Name | Description |
|-------|-----------|-------------|
| 0 | AwbAuto | Automatic white balance |
| 1 | AwbIncandescent | Incandescent lighting (2500-3000K) |
| 2 | AwbTungsten | Tungsten lighting (3000-3500K) |
| 3 | AwbFluorescent | Fluorescent lighting (4000-4700K) |
| 4 | AwbIndoor | Indoor lighting (3000-5000K) |
| 5 | AwbDaylight | Daylight (5500-6500K) |
| 6 | AwbCloudy | Cloudy conditions (7000-8600K) |
| 7 | AwbCustom | Custom (uses manual ColourGains) |

### Backend Validation

**File**: `src/conf.cpp:734`

```cpp
if (name == "libcam_awb_mode") return edit_generic_int(parm_cam.libcam_awb_mode, parm, pact, 0, 0, 7);
```

Backend accepts values 0-7, confirming all 8 modes are valid.

### Current Frontend State (WRONG)

**File**: `frontend/src/utils/parameterMappings.ts:111-119`

```typescript
export const AWB_MODES = [
  { value: 0, label: 'Auto' },          // CORRECT
  { value: 1, label: 'Tungsten' },      // WRONG - should be Incandescent
  { value: 2, label: 'Fluorescent' },   // WRONG - should be Tungsten
  { value: 3, label: 'Indoor' },        // WRONG - should be Fluorescent
  { value: 4, label: 'Daylight' },      // WRONG - should be Indoor
  { value: 5, label: 'Cloudy' },        // WRONG - should be Daylight
  { value: 6, label: 'Custom' },        // WRONG - should be Cloudy
  // MISSING: { value: 7, label: 'Custom' }
];
```

### Impact of Bug

Users selecting:
- "Tungsten" (value 1) actually get Incandescent
- "Fluorescent" (value 2) actually get Tungsten
- "Daylight" (value 4) actually get Indoor
- etc.

This causes incorrect white balance in all cases except "Auto" (value 0).

---

## Implementation Tasks

### Task 1: Replace AWB_MODES Array

**File**: `frontend/src/utils/parameterMappings.ts`

Replace lines 111-119 with correct libcamera values:

```typescript
// libcamera AWB modes - values must match libcamera::controls::AwbModeEnum
// Source: https://libcamera.org/api-html/namespacelibcamera_1_1controls.html
export const AWB_MODES = [
  { value: 0, label: 'Auto' },
  { value: 1, label: 'Incandescent' },
  { value: 2, label: 'Tungsten' },
  { value: 3, label: 'Fluorescent' },
  { value: 4, label: 'Indoor' },
  { value: 5, label: 'Daylight' },
  { value: 6, label: 'Cloudy' },
  { value: 7, label: 'Custom' },
];
```

### Task 2: Add Descriptive Comments (Optional Enhancement)

For better UX, consider adding color temperature descriptions:

```typescript
// libcamera AWB modes with color temperature guidance
export const AWB_MODES = [
  { value: 0, label: 'Auto', description: 'Automatic white balance' },
  { value: 1, label: 'Incandescent', description: 'Warm light (2500-3000K)' },
  { value: 2, label: 'Tungsten', description: 'Warm/tungsten (3000-3500K)' },
  { value: 3, label: 'Fluorescent', description: 'Cool white (4000-4700K)' },
  { value: 4, label: 'Indoor', description: 'Mixed indoor (3000-5000K)' },
  { value: 5, label: 'Daylight', description: 'Outdoor sun (5500-6500K)' },
  { value: 6, label: 'Cloudy', description: 'Overcast (7000-8600K)' },
  { value: 7, label: 'Custom', description: 'Manual color gains' },
];
```

---

## Verification Steps

1. **Visual check**:
   - Open Settings â†’ libcamera section
   - Open AWB Mode dropdown
   - Verify 8 options displayed in correct order:
     - Auto, Incandescent, Tungsten, Fluorescent, Indoor, Daylight, Cloudy, Custom

2. **Value mapping**:
   - Select "Daylight" (value 5)
   - Check network request - should send `libcam_awb_mode=5`
   - Check Motion logs - should show AWB mode 5 applied

3. **Visual verification on Pi** (with camera):
   - Point camera at known light source
   - Select "Daylight" - image should have slightly warm tint under indoor lighting
   - Select "Incandescent" - image should neutralize warm indoor lights
   - Verify visible difference between modes

4. **Mode 7 (Custom)**:
   - Select "Custom" mode
   - Verify AWB controls still function
   - Verify manual color gains can be set when AWB disabled

---

## Files Modified

| File | Change |
|------|--------|
| `frontend/src/utils/parameterMappings.ts` | Replace AWB_MODES array (lines 111-119) |

---

## Dependencies

- None (standalone fix)

---

## Migration Notes

Users who previously saved AWB mode settings will still have numeric values stored. Those values will now display with correct labels, but the actual camera behavior was always based on the numeric value - so:

- User who selected "Tungsten" (value 1) was actually getting Incandescent behavior
- After fix, their saved value 1 will show as "Incandescent" (now correct label)
- Camera behavior unchanged - only UI label corrected

No data migration needed.

---

## Testing Script (Manual on Pi)

```bash
# Test each AWB mode with a white reference card
for mode in 0 1 2 3 4 5 6 7; do
  echo "Testing AWB mode $mode"
  curl -s "http://localhost:7999/1/config/set?libcam_awb_mode=$mode"
  sleep 2
  # Take snapshot for visual comparison
  curl -s "http://localhost:7999/1/mjpg/stream" -o /tmp/awb_$mode.jpg &
  sleep 1
  kill $!
done
echo "Compare /tmp/awb_*.jpg files for visual differences"
```

---

## Notes

- This is a **bug fix**, not a feature addition
- All labels 1-6 were shifted by one position
- Mode 7 (Custom) was completely missing
- Backend was always working correctly - only UI labels were wrong
