# Sub-Agent Plan: 1.3 Expose Extended Codec Syntax (Pi 4 Hardware Encoding)

**Parent Plan**: `doc/plans/20260112-1500-ui-improvement-implementation.md`
**Priority**: High (Pi 4 CPU reduction from 40-70% to ~10%)
**Estimated Effort**: 2 hours

---

## Research Findings

### Container:Codec Syntax Parsing

**File**: `src/movie.cpp:1420-1430`

```cpp
container = cam->cfg->movie_container;

col_pos = container.find(":");
if (col_pos == std::string::npos) {
    preferred_codec = "";
} else {
    preferred_codec = container.substr(col_pos+1);
    container = container.substr(0,col_pos);
}
```

The backend parses `container:codec` format:
- `mkv` → container="mkv", preferred_codec=""
- `mkv:h264_v4l2m2m` → container="mkv", preferred_codec="h264_v4l2m2m"
- `mp4:libx264` → container="mp4", preferred_codec="libx264"

### Preferred Codec Usage

**File**: `src/movie.cpp:336-352`

```cpp
int cls_movie::set_codec_preferred()
{
    codec = nullptr;
    if (preferred_codec != "") {
        codec = avcodec_find_encoder_by_name(preferred_codec.c_str());
        if (codec == nullptr) {
            MOTION_LOG(NTC, TYPE_ENCODER, NO_ERRNO
                ,_("Failed to find user requested codec %s")
                , preferred_codec.c_str());
            codec = avcodec_find_encoder(oc->video_codec_id);
        } else {
            MOTION_LOG(NTC, TYPE_ENCODER, NO_ERRNO
                ,_("Using codec %s"), preferred_codec.c_str());
        }
    } else {
        codec = avcodec_find_encoder(oc->video_codec_id);
    }
    // ...
}
```

If preferred codec not found, falls back to container default codec.

### Hardware Encoder Handling

**File**: `src/movie.cpp:227-228`

```cpp
if (preferred_codec == "h264_v4l2m2m") {
    encode_nal();
}
```

Special NAL handling for Pi hardware encoder.

### Supported Containers

**File**: `src/movie.cpp:148-182`

| Container | File Extension | Default Codec |
|-----------|---------------|---------------|
| mov | .mov | H.264 |
| webm | .webm | VP8 |
| mp4 | .mp4 | H.264 |
| mkv | .mkv | H.264 |
| hevc | .mp4 | HEVC (H.265) |

### Conf.cpp Validation

**File**: `src/conf.cpp:860`

```cpp
static const std::vector<std::string> movie_container_values = {"mkv","mp4","3gp"};
```

Note: conf.cpp only validates simple values, but movie.cpp accepts any valid string including extended syntax.

### Current Frontend State

**File**: `frontend/src/utils/parameterMappings.ts:151-155`

```typescript
export const MOVIE_CONTAINERS = [
  { value: 'mkv', label: 'MKV (Matroska)' },
  { value: 'mp4', label: 'MP4' },
  { value: '3gp', label: '3GP' },
];
```

Only 3 basic containers, no extended syntax options.

---

## Implementation Tasks

### Task 1: Expand MOVIE_CONTAINERS Array

**File**: `frontend/src/utils/parameterMappings.ts`

Replace current `MOVIE_CONTAINERS` with organized groups:

```typescript
// Movie container formats with optional codec specification
// Format: container or container:codec
export const MOVIE_CONTAINERS = [
  // === Basic Containers (auto-select codec) ===
  { value: 'mkv', label: 'MKV (Matroska)', group: 'basic' },
  { value: 'mp4', label: 'MP4', group: 'basic' },
  { value: 'mov', label: 'MOV (QuickTime)', group: 'basic' },
  { value: '3gp', label: '3GP (Mobile)', group: 'basic' },

  // === Hardware Encoding (Pi 4 only, ~10% CPU) ===
  { value: 'mkv:h264_v4l2m2m', label: 'MKV - H.264 Hardware (Pi 4)', group: 'hardware' },
  { value: 'mp4:h264_v4l2m2m', label: 'MP4 - H.264 Hardware (Pi 4)', group: 'hardware' },

  // === Software H.264 (explicit) ===
  { value: 'mkv:libx264', label: 'MKV - H.264 Software', group: 'software' },
  { value: 'mp4:libx264', label: 'MP4 - H.264 Software', group: 'software' },

  // === H.265/HEVC (high CPU warning) ===
  { value: 'mkv:libx265', label: 'MKV - H.265 Software (high CPU)', group: 'hevc' },
  { value: 'hevc', label: 'HEVC/H.265 in MP4 (high CPU)', group: 'hevc' },

  // === WebM/VP8 ===
  { value: 'webm', label: 'WebM (VP8)', group: 'webm' },
];
```

### Task 2: Add Container Type Helper

**File**: `frontend/src/utils/parameterMappings.ts`

Add helper functions:

```typescript
// Check if container uses hardware encoding
export function isHardwareCodec(container: string): boolean {
  return container.includes('v4l2m2m');
}

// Check if container uses high-CPU codec
export function isHighCpuCodec(container: string): boolean {
  return container.includes('libx265') || container === 'hevc';
}

// Get container base (before colon)
export function getContainerBase(container: string): string {
  const colonPos = container.indexOf(':');
  return colonPos === -1 ? container : container.substring(0, colonPos);
}
```

### Task 3: Update MovieSettings.tsx Dropdown

**File**: `frontend/src/components/settings/MovieSettings.tsx`

1. Import new functions:
```typescript
import {
  MOVIE_CONTAINERS,
  ENCODER_PRESETS,
  isHardwareCodec,
  isHighCpuCodec
} from '../../utils/parameterMappings';
```

2. Update container dropdown with grouped options:
```typescript
<FormSelect
  label="Container Format"
  value={String(getValue('movie_container', 'mp4'))}
  onChange={(val) => onChange('movie_container', val)}
  options={MOVIE_CONTAINERS.map(c => ({
    value: c.value,
    label: c.label,
  }))}
  helpText="Video container format. Hardware options only work on Pi 4."
/>
```

3. Add conditional warnings based on selection:
```typescript
{/* Hardware encoding info */}
{isHardwareCodec(containerValue) && (
  <div className="text-xs text-blue-400 bg-blue-950/30 p-3 rounded mt-2">
    <strong>Hardware Encoding:</strong> Uses Pi 4's built-in H.264 encoder
    for ~10% CPU usage instead of 40-70%. Only available on Raspberry Pi 4.
    If encoder not found, falls back to software encoding.
  </div>
)}

{/* High CPU warning for HEVC */}
{isHighCpuCodec(containerValue) && (
  <div className="text-xs text-amber-400 bg-amber-950/30 p-3 rounded mt-2">
    <strong>High CPU Warning:</strong> H.265/HEVC software encoding uses
    80-100% CPU on Raspberry Pi. Not recommended for continuous recording.
    Consider H.264 for better performance.
  </div>
)}

{/* Pi 5 warning for hardware options */}
{isHardwareCodec(containerValue) && (
  <div className="text-xs text-amber-400 bg-amber-950/30 p-3 rounded mt-2">
    <strong>Pi 5 Note:</strong> Pi 5 does not have a hardware H.264 encoder.
    This option will fall back to software encoding on Pi 5.
  </div>
)}
```

### Task 4: Hide Encoder Preset for Hardware/WebM

**File**: `frontend/src/components/settings/MovieSettings.tsx`

Update the `showEncoderPreset` function (from Task 1.2):

```typescript
const showEncoderPreset = () => {
  const passthrough = getValue('movie_passthrough', false);
  const container = String(getValue('movie_container', 'mp4'));

  // Don't show for passthrough
  if (passthrough) return false;

  // Don't show for hardware encoding
  if (isHardwareCodec(container)) return false;

  // Don't show for WebM (VP8 doesn't use x264 presets)
  if (container === 'webm') return false;

  return true;
};
```

---

## Verification Steps

1. **UI renders correctly**:
   - All container options visible in dropdown
   - Options are readable and clearly labeled

2. **Hardware encoding options work on Pi 4**:
   - Select `mkv:h264_v4l2m2m`
   - Start recording
   - Check Motion logs for "Using codec h264_v4l2m2m"
   - Verify CPU ~10% instead of 40-70%

3. **Fallback on Pi 5**:
   - Select hardware option on Pi 5
   - Check logs for "Failed to find user requested codec h264_v4l2m2m"
   - Verify it falls back to software encoding

4. **High CPU warning displays**:
   - Select `mkv:libx265` or `hevc`
   - Verify amber warning appears

5. **Hardware info displays**:
   - Select `mkv:h264_v4l2m2m`
   - Verify blue info box appears

6. **Encoder preset hides for hardware**:
   - Select `mkv:h264_v4l2m2m`
   - Verify encoder preset dropdown is hidden

7. **Basic containers still work**:
   - Select `mkv`, `mp4`, `mov`
   - Verify recording works normally

---

## Files Modified

| File | Change |
|------|--------|
| `frontend/src/utils/parameterMappings.ts` | Expand MOVIE_CONTAINERS, add helper functions |
| `frontend/src/components/settings/MovieSettings.tsx` | Update dropdown, add conditional warnings |

---

## Dependencies

- Task 1.2 (encoder preset) should be done first as this task modifies `showEncoderPreset`

---

## Notes

- Backend accepts any `container:codec` format, not limited to the options we expose
- If codec not found, backend logs warning and uses container default
- Hardware encoding NAL handling is automatic (movie.cpp:227)
- VP8 (webm) has its own quality settings, x264 presets don't apply
- Consider grouping options in the dropdown UI for better UX (basic, hardware, software, etc.)
