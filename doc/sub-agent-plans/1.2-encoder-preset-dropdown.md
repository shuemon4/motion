# Sub-Agent Plan: 1.2 Expose movie_encoder_preset Dropdown

**Parent Plan**: `doc/plans/20260112-1500-ui-improvement-implementation.md`
**Priority**: Critical (Pi 5 CPU optimization)
**Estimated Effort**: 1 hour

---

## Research Findings

### Backend Parameter Details

**Location**: `src/conf.cpp:173, 857-858`

```cpp
// conf.cpp:173
{"movie_encoder_preset", PARM_TYP_LIST, PARM_CAT_10, PARM_LEVEL_LIMITED, false},

// conf.cpp:857-858
static const std::vector<std::string> movie_encoder_preset_values =
    {"ultrafast","superfast","veryfast","faster","fast","medium","slow","slower","veryslow"};
if (name == "movie_encoder_preset")
    return edit_generic_list(movie_encoder_preset, parm, pact, "medium", movie_encoder_preset_values);
```

**Key Facts**:
- Parameter name: `movie_encoder_preset`
- Type: PARM_TYP_LIST (dropdown)
- Category: PARM_CAT_10 (Movies)
- Hot-reload: `false` (requires restart)
- Default: `"medium"`
- Valid values: ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow

### Usage in movie.cpp

```cpp
// movie.cpp:320
av_opt_set(ctx_codec->priv_data, "preset", cam->cfg->movie_encoder_preset.c_str(), 0);
```

This is used only for software H.264/H.265 encoding (libx264, libx265). It does NOT affect:
- Hardware encoding (h264_v4l2m2m)
- Passthrough mode
- VP8/VP9 encoding (webm)

### Current Frontend State

**File**: `frontend/src/utils/parameterMappings.ts`

The parameter `movie_encoder_preset` is NOT in `DIRECT_MAPPINGS` and no `ENCODER_PRESETS` array exists.

**File**: `frontend/src/components/settings/MovieSettings.tsx`

No encoder preset dropdown exists in the current UI.

---

## Implementation Tasks

### Task 1: Add ENCODER_PRESETS to parameterMappings.ts

**File**: `frontend/src/utils/parameterMappings.ts`

Add after `MOVIE_CONTAINERS` (around line 156):

```typescript
// Encoder presets for software encoding (libx264/libx265)
// Affects CPU usage vs quality tradeoff
// Note: Does NOT apply to hardware encoding or passthrough
export const ENCODER_PRESETS = [
  { value: 'ultrafast', label: 'Ultrafast', description: 'Lowest CPU (~35-40%), lowest quality' },
  { value: 'superfast', label: 'Superfast', description: 'Very low CPU' },
  { value: 'veryfast', label: 'Very Fast', description: 'Low CPU' },
  { value: 'faster', label: 'Faster', description: 'Below average CPU' },
  { value: 'fast', label: 'Fast', description: 'Slightly below average CPU' },
  { value: 'medium', label: 'Medium (Default)', description: 'Balanced CPU/quality (~50-60%)' },
  { value: 'slow', label: 'Slow', description: 'Above average quality' },
  { value: 'slower', label: 'Slower', description: 'High quality' },
  { value: 'veryslow', label: 'Very Slow', description: 'Highest quality (~70-80%), highest CPU' },
];
```

### Task 2: Add movie_encoder_preset to DIRECT_MAPPINGS

**File**: `frontend/src/utils/parameterMappings.ts`

In `DIRECT_MAPPINGS` object, add under Movies section (after `movie_container`):

```typescript
  movie_encoder_preset: 'movie_encoder_preset',
```

### Task 3: Add Encoder Preset Dropdown to MovieSettings.tsx

**File**: `frontend/src/components/settings/MovieSettings.tsx`

1. Import ENCODER_PRESETS:
```typescript
import { ENCODER_PRESETS, MOVIE_CONTAINERS } from '../../utils/parameterMappings';
```

2. Add helper to check if preset is relevant:
```typescript
// Encoder preset only applies to software encoding, not:
// - Passthrough mode
// - Hardware encoding (h264_v4l2m2m)
// - VP8/VP9 (webm)
const showEncoderPreset = () => {
  const passthrough = getValue('movie_passthrough', false);
  const container = String(getValue('movie_container', 'mp4'));

  if (passthrough) return false;
  if (container.includes('v4l2m2m')) return false;
  if (container === 'webm') return false;

  return true;
};
```

3. Add dropdown after container dropdown (conditionally rendered):
```typescript
{showEncoderPreset() && (
  <FormSelect
    label="Encoder Preset"
    value={String(getValue('movie_encoder_preset', 'medium'))}
    onChange={(val) => onChange('movie_encoder_preset', val)}
    options={ENCODER_PRESETS.map(p => ({
      value: p.value,
      label: p.label,
    }))}
    helpText="Tradeoff between CPU usage and video quality. Lower presets use less CPU but produce lower quality video. Requires restart to take effect."
  />
)}
```

4. Add warning for Pi 5 continuous recording (if device detection available):
```typescript
{showEncoderPreset() && emulateMotionEnabled && (
  <div className="text-xs text-amber-400 bg-amber-950/30 p-3 rounded mt-2">
    <strong>CPU Tip:</strong> For continuous recording, consider using "Ultrafast"
    preset to reduce CPU usage by ~30%. Pi 5 has no hardware encoder.
  </div>
)}
```

---

## Verification Steps

1. **UI renders correctly**:
   - Encoder preset dropdown appears after container dropdown
   - Default value is "Medium (Default)"
   - All 9 options are visible

2. **Conditional visibility**:
   - Dropdown hidden when passthrough enabled
   - Dropdown hidden when hardware codec selected (e.g., `mkv:h264_v4l2m2m`)
   - Dropdown hidden when webm selected

3. **Value persistence**:
   - Select "ultrafast", save, reload page - value persists
   - Value is sent to backend API correctly

4. **Backend receives value**:
   - Check Motion logs for encoder preset in use
   - Verify `movie_encoder_preset=ultrafast` in config

5. **Actual encoding uses preset** (on Pi):
   - Enable recording, check CPU usage with "ultrafast" vs "medium"
   - Expect ~30% reduction in CPU with ultrafast

---

## Files Modified

| File | Change |
|------|--------|
| `frontend/src/utils/parameterMappings.ts` | Add ENCODER_PRESETS array, add to DIRECT_MAPPINGS |
| `frontend/src/components/settings/MovieSettings.tsx` | Add FormSelect dropdown with conditional rendering |

---

## Dependencies

- None (standalone change)

---

## Notes

- The preset only affects software encoders (libx264, libx265)
- Hardware encoding (Pi 4) ignores this setting
- Hot-reload is `false` - user must restart Motion for change to take effect
- UI should indicate restart required in helpText
