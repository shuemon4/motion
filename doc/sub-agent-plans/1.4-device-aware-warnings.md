# Sub-Agent Plan: 1.4 Add Device-Aware CPU Warnings

**Parent Plan**: `doc/plans/20260112-1500-ui-improvement-implementation.md`
**Priority**: High (prevents thermal issues, improves UX)
**Estimated Effort**: 3-4 hours (includes backend change)

---

## Research Findings

### Current State

**status.json Response** (`src/webu_json.cpp:518-589`):
- Includes: name, id, width, height, fps, current_time, lost_connection, detecting, pause, supportedControls
- Does NOT include: device_model, hardware_encoders

**api/system/status Response** (`src/webu_json.cpp:1253-1336`):
- Includes: temperature, uptime, memory, disk, version
- Does NOT include: device_model, hardware_encoders

### Device Detection Options

**Option A: Add device_model to Backend (Recommended)**

Read Pi model from `/proc/device-tree/model`:
```bash
# Example output:
cat /proc/device-tree/model
# Raspberry Pi 5 Model B Rev 1.0

cat /proc/device-tree/model
# Raspberry Pi 4 Model B Rev 1.5
```

**Option B: Detect from Hardware Encoder Availability**

Backend can check if h264_v4l2m2m codec is available at startup:
```cpp
AVCodec *codec = avcodec_find_encoder_by_name("h264_v4l2m2m");
bool has_hw_encoder = (codec != nullptr);
```

**Option C: Frontend-Only Detection (Limited)**

Show warnings based on user's codec selection without knowing actual device:
- Already partially implemented in MovieSettings.tsx
- Limited because can't proactively warn about missing hardware encoder

### Recommended Approach

Use **Option A + C combined**:
1. Add device_model and has_hw_encoder to api/system/status (backend)
2. Frontend fetches device info and shows appropriate warnings
3. Fallback: Show codec-based warnings even without device info

---

## Implementation Tasks

### Phase 1: Backend Changes

#### Task 1.1: Add Device Model to api/system/status

**File**: `src/webu_json.cpp`

In `api_system_status()` function (around line 1331), add device model detection:

```cpp
/* Device Model (Raspberry Pi) */
file = fopen("/proc/device-tree/model", "r");
if (file != nullptr) {
    if (fgets(buffer, sizeof(buffer), file)) {
        /* Remove trailing newline */
        size_t len = strlen(buffer);
        if (len > 0 && buffer[len-1] == '\n') {
            buffer[len-1] = '\0';
        }
        webua->resp_page += ",\"device_model\":\"" + escstr(buffer) + "\"";

        /* Detect Pi generation */
        if (strstr(buffer, "Pi 5") != nullptr) {
            webua->resp_page += ",\"pi_generation\":5";
        } else if (strstr(buffer, "Pi 4") != nullptr) {
            webua->resp_page += ",\"pi_generation\":4";
        } else if (strstr(buffer, "Pi 3") != nullptr) {
            webua->resp_page += ",\"pi_generation\":3";
        } else {
            webua->resp_page += ",\"pi_generation\":0";
        }
    }
    fclose(file);
}
```

#### Task 1.2: Add Hardware Encoder Availability Check

**File**: `src/webu_json.cpp`

Add hardware encoder detection in `api_system_status()`:

```cpp
/* Hardware Encoder Availability */
webua->resp_page += ",\"hardware_encoders\":{";
#ifdef HAVE_FFMPEG
{
    const AVCodec *codec;

    /* Check for V4L2 M2M H.264 encoder (Pi 4 only) */
    codec = avcodec_find_encoder_by_name("h264_v4l2m2m");
    webua->resp_page += "\"h264_v4l2m2m\":" + std::string(codec ? "true" : "false");

    /* Could add more codecs here */
}
#else
    webua->resp_page += "\"h264_v4l2m2m\":false";
#endif
webua->resp_page += "}";
```

Add include at top if needed:
```cpp
#ifdef HAVE_FFMPEG
extern "C" {
#include <libavcodec/avcodec.h>
}
#endif
```

### Phase 2: Frontend Changes

#### Task 2.1: Create useDeviceInfo Hook

**File**: `frontend/src/hooks/useDeviceInfo.ts` (NEW)

```typescript
import { useQuery } from '@tanstack/react-query';

export interface DeviceInfo {
  device_model?: string;
  pi_generation?: number;
  hardware_encoders?: {
    h264_v4l2m2m: boolean;
  };
  temperature?: {
    celsius: number;
    fahrenheit: number;
  };
}

export function useDeviceInfo() {
  return useQuery({
    queryKey: ['deviceInfo'],
    queryFn: async (): Promise<DeviceInfo> => {
      const response = await fetch('/0/api/system/status');
      if (!response.ok) {
        throw new Error('Failed to fetch device info');
      }
      return response.json();
    },
    staleTime: 60000, // Cache for 1 minute
    retry: 1,
  });
}

// Helper functions
export function isPi5(deviceInfo?: DeviceInfo): boolean {
  return deviceInfo?.pi_generation === 5;
}

export function isPi4(deviceInfo?: DeviceInfo): boolean {
  return deviceInfo?.pi_generation === 4;
}

export function hasHardwareEncoder(deviceInfo?: DeviceInfo): boolean {
  return deviceInfo?.hardware_encoders?.h264_v4l2m2m === true;
}
```

#### Task 2.2: Update MovieSettings.tsx with Device-Aware Warnings

**File**: `frontend/src/components/settings/MovieSettings.tsx`

1. Import the hook:
```typescript
import { useDeviceInfo, isPi5, isPi4, hasHardwareEncoder } from '@/hooks/useDeviceInfo';
```

2. Use the hook in component:
```typescript
export function MovieSettings({ config, onChange, getError }: MovieSettingsProps) {
  const { data: deviceInfo } = useDeviceInfo();

  // ... existing code ...
```

3. Add device-aware warnings after container selection:

```typescript
{/* Pi 5 warning for continuous recording without optimal settings */}
{isPi5(deviceInfo) && selectedMode === 'continuous' && !getValue('movie_passthrough', false) && (
  <div className="text-xs text-amber-400 bg-amber-950/30 p-3 rounded mt-2">
    <strong>Pi 5 CPU Warning:</strong> Pi 5 does not have a hardware H.264 encoder.
    Continuous recording uses software encoding (~35-60% CPU constant).
    <ul className="list-disc ml-4 mt-1">
      <li>Use encoder preset "Ultrafast" to reduce CPU by ~30%</li>
      <li>Add active cooling (fan) to prevent thermal throttling</li>
      <li>Enable passthrough if source is already H.264</li>
    </ul>
  </div>
)}

{/* Pi 4 tip for hardware encoding */}
{isPi4(deviceInfo) && hasHardwareEncoder(deviceInfo) &&
 !isHardwareCodec(containerValue) && !getValue('movie_passthrough', false) && (
  <div className="text-xs text-blue-400 bg-blue-950/30 p-3 rounded mt-2">
    <strong>Pi 4 Hardware Encoding Available:</strong> Your Pi 4 has a hardware
    H.264 encoder. Select "MKV - H.264 Hardware (Pi 4)" or "MP4 - H.264 Hardware (Pi 4)"
    to reduce CPU from ~40-70% to ~10%.
  </div>
)}

{/* Hardware codec selected but no hardware encoder */}
{isHardwareCodec(containerValue) && !hasHardwareEncoder(deviceInfo) && deviceInfo && (
  <div className="text-xs text-amber-400 bg-amber-950/30 p-3 rounded mt-2">
    <strong>Hardware Encoder Not Available:</strong> The h264_v4l2m2m hardware encoder
    is not available on this device. Motion will fall back to software encoding.
    {isPi5(deviceInfo) && ' Pi 5 does not have a hardware H.264 encoder.'}
  </div>
)}

{/* Temperature warning */}
{deviceInfo?.temperature && deviceInfo.temperature.celsius > 70 && (
  <div className="text-xs text-red-400 bg-red-950/30 p-3 rounded mt-2">
    <strong>High Temperature Warning:</strong> Device is running at {deviceInfo.temperature.celsius.toFixed(1)}°C.
    Consider reducing encoding quality or adding active cooling.
  </div>
)}
```

4. Update existing warnings to be conditional on device info:

```typescript
{/* Generic continuous recording warning (fallback when no device info) */}
{selectedMode === 'continuous' && !deviceInfo && (
  <div className="text-xs text-yellow-200 bg-yellow-600/10 border border-yellow-600/30 p-3 rounded">
    <strong>Continuous Recording:</strong> Uses significant CPU for encoding.
    Consider enabling passthrough mode or reducing quality on resource-constrained devices.
  </div>
)}
```

#### Task 2.3: Add Device Info Display (Optional)

**File**: `frontend/src/components/settings/MovieSettings.tsx`

Add small device info display in the debug section:

```typescript
{/* Device info for debugging */}
{deviceInfo && (
  <div className="text-xs text-gray-500 mt-1">
    Device: {deviceInfo.device_model || 'Unknown'}
    {deviceInfo.hardware_encoders?.h264_v4l2m2m && ' | HW Encoder: Available'}
    {deviceInfo.temperature && ` | Temp: ${deviceInfo.temperature.celsius.toFixed(1)}°C`}
  </div>
)}
```

---

## Verification Steps

### Backend Verification

```bash
# Test api/system/status endpoint
curl -s http://localhost:7999/0/api/system/status | jq .

# Expected response includes:
# {
#   "temperature": { "celsius": 45.2, ... },
#   "device_model": "Raspberry Pi 5 Model B Rev 1.0",
#   "pi_generation": 5,
#   "hardware_encoders": { "h264_v4l2m2m": false },
#   ...
# }
```

### Frontend Verification

1. **Pi 5 Test**:
   - Open Settings → Movie Settings on Pi 5
   - Enable "Continuous Recording"
   - Verify amber warning appears about no hardware encoder
   - Verify recommendations shown

2. **Pi 4 Test**:
   - Open Settings → Movie Settings on Pi 4
   - Use software container (mp4)
   - Verify blue tip appears recommending hardware encoding
   - Select hardware codec
   - Verify tip disappears

3. **Temperature Test**:
   - Heat up Pi (run stress test)
   - Verify temperature warning appears when >70°C

4. **Fallback Test**:
   - Block /0/api/system/status (or use non-Pi device)
   - Verify generic warnings still appear
   - Verify no JS errors

---

## Files Modified

### Backend
| File | Change |
|------|--------|
| `src/webu_json.cpp` | Add device_model, pi_generation, hardware_encoders to api_system_status |

### Frontend
| File | Change |
|------|--------|
| `frontend/src/hooks/useDeviceInfo.ts` | NEW: Hook to fetch device info |
| `frontend/src/components/settings/MovieSettings.tsx` | Add device-aware conditional warnings |

---

## Dependencies

- Task 1.1 (continuous recording) should be done first
- Backend changes must be deployed before frontend can use device info
- Fallback warnings should work without backend changes

---

## Alternative: Frontend-Only Implementation

If backend changes are not desired initially, implement with frontend-only approach:

1. Keep existing codec-based warnings (already in place)
2. Add warning when hardware codec selected:
   ```typescript
   {isHardwareCodec(containerValue) && (
     <div className="text-xs text-blue-400 ...">
       <strong>Hardware Encoding:</strong> This option uses Pi 4's hardware encoder.
       If you're on Pi 5, this will fall back to software encoding as Pi 5 lacks
       hardware H.264 encoding.
     </div>
   )}
   ```
3. Defer device detection to future release

This provides immediate value without backend changes, but is less targeted.

---

## CPU Impact Reference

| Device | Scenario | Expected CPU |
|--------|----------|--------------|
| Pi 5 | SW encoding, medium preset | ~50-60% |
| Pi 5 | SW encoding, ultrafast | ~35-40% |
| Pi 5 | Passthrough | ~5-10% |
| Pi 4 | HW encoding (h264_v4l2m2m) | ~10% |
| Pi 4 | SW encoding, medium preset | ~40-70% |
| Pi 4 | Passthrough | ~5-10% |

These values should be referenced in warnings to give users concrete expectations.

---

## Notes

- Device model detection only works on Linux with /proc/device-tree/model
- Non-Pi Linux systems will show pi_generation: 0
- Hardware encoder availability is runtime-detected via FFmpeg
- Temperature monitoring uses standard Linux thermal zone
- All warnings have graceful fallbacks if device info unavailable

---

## Implementation Summary (Completed 2026-01-13)

### Backend Changes Implemented

**File: `src/webu_json.cpp`** (lines 1331-1366)

Added to `api_system_status()`:
1. **Device Model Detection**: Reads `/proc/device-tree/model` to identify Raspberry Pi model
2. **Pi Generation Detection**: Parses model string to determine Pi generation (3, 4, 5, or 0 for unknown)
3. **Hardware Encoder Check**: Uses `avcodec_find_encoder_by_name("h264_v4l2m2m")` to detect V4L2 M2M encoder availability

New JSON fields in response:
```json
{
  "device_model": "Raspberry Pi 5 Model B Rev 1.0",
  "pi_generation": 5,
  "hardware_encoders": {
    "h264_v4l2m2m": false
  }
}
```

### Frontend Changes Implemented

**File: `frontend/src/hooks/useDeviceInfo.ts`** (NEW)
- Created `useDeviceInfo()` hook with TanStack Query
- Added helper functions: `isPi5()`, `isPi4()`, `isPi3()`, `isRaspberryPi()`, `hasHardwareEncoder()`, `isHighTemperature()`
- 60-second cache with graceful error handling

**File: `frontend/src/components/settings/MovieSettings.tsx`**
- Integrated `useDeviceInfo` hook
- Added device-aware conditional warnings:
  - **Green (Pi 4 + HW encoder active)**: Confirms hardware encoding is active
  - **Amber (Pi 5 continuous recording)**: Warns about no HW encoder, suggests ultrafast preset
  - **Amber (HW codec on non-HW device)**: Warns about fallback to software encoding
  - **Blue (Pi 4 suggestion)**: Suggests hardware encoding when software codec selected
  - **Red (>70°C)**: Temperature warning with cooling recommendation
- Generic fallbacks when device info unavailable

### Verification

- Frontend build: ✓ Successful
- TypeScript: ✓ No type errors
- ESLint: ✓ No errors in modified files

### Testing Notes

Backend must be deployed to Pi before frontend device-aware features become active. Until then, generic fallback warnings are shown.
