import{r as t,j as e,u as A,a as $,b as O,c as Y,d as z,s as P}from"./index-D3SPoPQ6.js";import{p as W,a as Q,C as q,F as w,b as T}from"./translations-CaYdUBVR.js";function V(r){const[o,l]=t.useState(""),[c,a]=t.useState(!0),[i,u]=t.useState(null);return t.useEffect(()=>{const g=`/${r}/mjpg/stream`,d=new Image;return d.onload=()=>{l(g),a(!1)},d.onerror=()=>{u("Stream not available"),a(!1)},d.src=g,()=>{d.onload=null,d.onerror=null}},[r]),{streamUrl:o,isLoading:c,error:i}}function H(r){const[o,l]=t.useState(0),c=t.useRef([]);return t.useEffect(()=>{const a=r.current;if(!a)return;const i=()=>{const u=performance.now();c.current.push(u);const g=u-1e3;for(;c.current.length>0&&c.current[0]<g;)c.current.shift();l(c.current.length)};return a.addEventListener("load",i),()=>{a.removeEventListener("load",i),c.current=[]}},[r]),o}function F({cameraId:r,className:o="",onFpsChange:l,onFullscreenRequest:c}){const{streamUrl:a,isLoading:i,error:u}=V(r),[g,d]=t.useState(!1),f=t.useRef(null),m=H(f);t.useEffect(()=>{l&&l(m)},[m,l]);const p=t.useCallback(()=>{c?c():d(!0)},[c]),b=t.useCallback(h=>{h.preventDefault(),h.stopPropagation(),d(!1)},[]);return t.useEffect(()=>{if(!g)return;const h=v=>{v.key==="Escape"&&d(!1)};return document.addEventListener("keydown",h),document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",h),document.body.style.overflow=""}},[g]),u?e.jsx("div",{className:`w-full ${o}`,children:e.jsx("div",{className:"aspect-video flex items-center justify-center bg-gray-900 rounded-lg",children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("svg",{className:"w-12 h-12 mx-auto text-red-500 mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),e.jsx("p",{className:"text-red-500 text-sm",children:u})]})})}):i?e.jsx("div",{className:`w-full ${o}`,children:e.jsx("div",{className:"relative aspect-video bg-gray-900 animate-pulse rounded-lg",children:e.jsx("div",{className:"absolute top-4 right-4",children:e.jsxs("svg",{className:"w-8 h-8 text-gray-600 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})})})}):e.jsxs(e.Fragment,{children:[g&&e.jsxs("div",{className:"fixed inset-0 z-[9999] bg-black flex items-center justify-center",children:[e.jsx("button",{type:"button",onClick:b,className:"absolute top-4 right-4 z-[10000] p-3 bg-white/20 hover:bg-white/40 rounded-full transition-colors","aria-label":"Close fullscreen",children:e.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 text-white/60 text-sm",children:"Press ESC or click X to close"}),e.jsx("img",{src:a,alt:`Camera ${r} stream fullscreen`,className:"max-w-[95vw] max-h-[95vh] object-contain"})]}),e.jsx("div",{className:`w-full ${o}`,children:e.jsxs("div",{className:"relative aspect-video bg-black rounded-lg overflow-hidden cursor-pointer group",onClick:p,children:[e.jsx("img",{ref:f,src:a,alt:`Camera ${r} stream`,className:"absolute inset-0 w-full h-full object-contain"}),e.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-colors flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity bg-black/60 rounded-full p-4",children:e.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"})})})})]})})]})}function U({isOpen:r,onClose:o,sheetRef:l,closeThreshold:c=.3}){const[a,i]=t.useState(!1),[u,g]=t.useState(0),d=t.useRef(0),f=t.useRef(0),m=t.useRef(0),p=t.useRef(0),b=t.useRef(0),h=t.useCallback(x=>{i(!0),d.current=x,f.current=x,b.current=x,p.current=Date.now(),m.current=0},[]),v=t.useCallback(x=>{if(!a)return;const C=Date.now(),E=C-p.current,L=x-b.current;E>0&&(m.current=L/E),p.current=C,b.current=x,f.current=x;const S=Math.max(0,x-d.current);g(S)},[a]),j=t.useCallback(()=>{if(!a)return;i(!1);const x=l.current?.offsetHeight||400;(u>x*c||m.current>.5)&&o(),g(0),m.current=0},[a,u,o,c,l]),y=t.useCallback(x=>{const C=x.touches[0],E=l.current?.getBoundingClientRect().top||0;C.clientY-E<=60&&h(C.clientY)},[h,l]),n=t.useCallback(x=>{a&&(x.preventDefault(),v(x.touches[0].clientY))},[a,v]),k=t.useCallback(()=>{j()},[j]),s=t.useCallback(x=>{const C=l.current?.getBoundingClientRect().top||0;if(x.clientY-C<=60){h(x.clientY);const L=R=>{v(R.clientY)},S=()=>{j(),document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",S)};document.addEventListener("mousemove",L),document.addEventListener("mouseup",S)}},[h,v,j,l]),N=r?a?`translateY(${u}px)`:"translateY(0)":"translateY(100%)";return{handlers:{onTouchStart:y,onTouchMove:n,onTouchEnd:k,onMouseDown:s},style:{transform:N},state:{isDragging:a,dragOffset:u}}}function B({isOpen:r,onClose:o,title:l,children:c,headerRight:a}){const i=t.useRef(null),u=t.useRef(null),g=t.useRef(null),{handlers:d,style:f}=U({isOpen:r,onClose:o,sheetRef:i});t.useEffect(()=>{if(!r)return;const p=h=>{h.key==="Escape"&&o()},b=h=>{if(h.key!=="Tab"||!i.current)return;const v=i.current.querySelectorAll('button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'),j=v[0],y=v[v.length-1];j&&(h.shiftKey?document.activeElement===j&&(h.preventDefault(),y?.focus()):document.activeElement===y&&(h.preventDefault(),j?.focus()))};return document.addEventListener("keydown",p),document.addEventListener("keydown",b),()=>{document.removeEventListener("keydown",p),document.removeEventListener("keydown",b)}},[r,o]),t.useEffect(()=>(r?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[r]),t.useEffect(()=>{r?(g.current=document.activeElement,setTimeout(()=>{if(i.current){const p=i.current.querySelectorAll('button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');p.length>0&&p[0].focus()}},100)):g.current&&g.current.focus()},[r]);const m=t.useCallback(p=>{p.target===p.currentTarget&&o()},[o]);return r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[100]",onClick:m,"aria-hidden":"true"}),e.jsxs("div",{ref:i,className:"fixed bottom-0 left-0 right-0 z-[101] bg-surface/95 backdrop-blur-sm rounded-t-2xl shadow-2xl transition-transform duration-300 ease-out border-t border-surface-elevated",style:{maxHeight:"45vh",transform:f.transform},role:"dialog","aria-modal":"true","aria-label":l,...d,children:[e.jsx("div",{className:"flex justify-center pt-3 pb-2 cursor-grab active:cursor-grabbing touch-none",children:e.jsx("div",{className:"w-12 h-1.5 bg-gray-500 rounded-full"})}),e.jsxs("div",{className:"flex items-center justify-between px-4 pb-3 border-b border-surface-elevated",children:[e.jsx("h2",{className:"text-lg font-semibold",children:l}),e.jsxs("div",{className:"flex items-center gap-3",children:[a,e.jsx("button",{type:"button",onClick:o,className:"p-2 hover:bg-surface-elevated rounded-full transition-colors","aria-label":"Close",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),e.jsx("div",{ref:u,className:"overflow-y-auto overscroll-contain px-4 py-4",style:{maxHeight:"calc(45vh - 80px)"},children:c})]})]}):null}function M({title:r,defaultOpen:o=!0,children:l}){const[c,a]=t.useState(o);return e.jsxs("div",{className:"mb-4",children:[e.jsxs("button",{type:"button",className:"flex items-center justify-between w-full py-2 text-left",onClick:()=>a(!c),children:[e.jsx("span",{className:"font-medium text-sm",children:r}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${c?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),c&&e.jsx("div",{className:"pt-2",children:l})]})}function D({cameraId:r,config:o}){const{mutate:l,isPending:c}=A(),[a,i]=t.useState(null),[u,g]=t.useState({}),d=t.useRef({});t.useEffect(()=>()=>{Object.values(d.current).forEach(clearTimeout)},[]),t.useEffect(()=>{g({})},[o]);const f=t.useCallback((n,k="")=>n in u?u[n]:o[n]?.value??k,[o,u]);t.useEffect(()=>{Object.values(d.current).forEach(clearTimeout),d.current={}},[r]);const m=t.useCallback((n,k)=>{g(N=>({...N,[n]:k})),d.current[n]&&clearTimeout(d.current[n]);const s=r;d.current[n]=setTimeout(()=>{l({camId:s,changes:{[n]:k}},{onSuccess:()=>{i(n),setTimeout(()=>i(null),1e3)}})},300)},[r,l]),p=t.useCallback((n,k)=>{g(s=>({...s,[n]:k})),l({camId:r,changes:{[n]:k}},{onSuccess:()=>{i(n),setTimeout(()=>i(null),1e3)}})},[r,l]),b=Number(f("width",640)),h=Number(f("height",480)),v=Number(f("threshold",1500)),j=W(v,b,h),y=t.useCallback(n=>{const k=Q(n,b,h);m("threshold",k)},[b,h,m]);return e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{cameraId:r,readOnly:!0}),e.jsxs(M,{title:"Stream",defaultOpen:!0,children:[e.jsx(w,{label:"Quality",value:Number(f("stream_quality",50)),onChange:n=>m("stream_quality",n),min:1,max:100,unit:"%",helpText:"JPEG compression quality"}),e.jsx(w,{label:"Max Framerate",value:Number(f("stream_maxrate",15)),onChange:n=>m("stream_maxrate",n),min:1,max:30,unit:" fps",helpText:"Maximum stream framerate"}),e.jsx(T,{label:"Show Motion Boxes",value:!!f("stream_motion",!1),onChange:n=>p("stream_motion",n),helpText:"Display motion detection boxes"})]}),e.jsxs(M,{title:"Image",defaultOpen:!0,children:[e.jsx(w,{label:"Brightness",value:Number(f("libcam_brightness",0)),onChange:n=>m("libcam_brightness",n),min:-1,max:1,step:.1,helpText:"Brightness adjustment"}),e.jsx(w,{label:"Contrast",value:Number(f("libcam_contrast",1)),onChange:n=>m("libcam_contrast",n),min:0,max:32,step:.5,helpText:"Contrast adjustment"}),e.jsx(w,{label:"Gain (ISO)",value:Number(f("libcam_iso",0)),onChange:n=>m("libcam_iso",n),min:0,max:6400,step:100,scale:"logarithmic",helpText:"ISO sensitivity (0=auto)"})]}),e.jsxs(M,{title:"Detection",defaultOpen:!1,children:[e.jsx(w,{label:"Threshold",value:j,onChange:y,min:0,max:20,step:.1,unit:"%",helpText:"Motion sensitivity (higher = less sensitive)"}),e.jsx(w,{label:"Noise Level",value:Number(f("noise_level",32)),onChange:n=>m("noise_level",n),min:1,max:255,helpText:"Noise tolerance"}),e.jsx(T,{label:"Auto-tune Noise",value:!!f("noise_tune",!1),onChange:n=>p("noise_tune",n),helpText:"Automatically adjust noise level"})]}),e.jsx(M,{title:"Overlay",defaultOpen:!1,children:e.jsx(w,{label:"Text Scale",value:Number(f("text_scale",1)),onChange:n=>m("text_scale",n),min:1,max:10,unit:"x",helpText:"Overlay text size"})}),c&&e.jsx("div",{className:"text-center text-sm text-gray-400 py-2",children:"Applying..."}),a&&!c&&e.jsx("div",{className:"text-center text-sm text-green-400 py-2",children:"Applied!"})]})}function _({cameraId:r}){const[o,l]=t.useState(!1),c=a=>{a.stopPropagation();const i=document.querySelector(`[data-camera-id="${r}"]`);i&&(o?document.exitFullscreen&&document.exitFullscreen():i.requestFullscreen&&i.requestFullscreen())};return t.useEffect(()=>{const a=()=>{l(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",a),()=>{document.removeEventListener("fullscreenchange",a)}},[]),e.jsx("button",{type:"button",onClick:c,className:"p-1.5 hover:bg-surface rounded-full transition-colors","aria-label":"Toggle fullscreen",title:"Toggle fullscreen",children:e.jsx("svg",{className:"w-5 h-5 text-gray-400 hover:text-gray-200",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:o?e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25"}):e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"})})})}function I({cameraId:r,onClick:o}){return e.jsx("button",{type:"button",onClick:l=>{l.stopPropagation(),o(r)},className:"p-1.5 hover:bg-surface rounded-full transition-colors","aria-label":"Quick settings",title:"Quick settings",children:e.jsxs("svg",{className:"w-5 h-5 text-gray-400 hover:text-gray-200",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})})}function J(){const{data:r,isLoading:o,error:l}=$(),{role:c}=O(),[a,i]=t.useState(!1),[u,g]=t.useState(null),[d,f]=t.useState({}),{data:m}=Y({queryKey:["config-quick"],queryFn:async()=>{const s=await z("/0/api/config");return s.csrf_token&&P(s.csrf_token),s},enabled:a,staleTime:3e4}),p=s=>{g(s),i(!0)},b=()=>{i(!1)},h=(s,N)=>{f(x=>({...x,[s]:N}))},v=r?.find(s=>s.id===u),j=v?`Quick Settings - ${v.name}`:"Quick Settings",y=t.useMemo(()=>{if(!m||!u)return{};const s=m.configuration?.default||{},N=m.configuration?.[`cam${u}`]||{};return{...s,...N}},[m,u]);if(o)return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6",children:"Camera Dashboard"}),e.jsx("div",{className:"flex flex-col items-center gap-6",children:[1].map(s=>e.jsxs("div",{className:"bg-surface-elevated rounded-lg p-4 animate-pulse w-full max-w-4xl",children:[e.jsx("div",{className:"h-6 bg-surface rounded w-1/3 mb-4"}),e.jsx("div",{className:"aspect-video bg-surface rounded"})]},s))})]});if(l)return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6",children:"Camera Dashboard"}),e.jsxs("div",{className:"bg-danger/10 border border-danger rounded-lg p-4 max-w-2xl mx-auto",children:[e.jsxs("p",{className:"text-danger",children:["Failed to load cameras: ",l instanceof Error?l.message:"Unknown error"]}),e.jsx("button",{className:"mt-2 text-sm text-primary hover:underline",onClick:()=>window.location.reload(),children:"Retry"})]})]});if(!r||r.length===0)return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6",children:"Camera Dashboard"}),e.jsxs("div",{className:"bg-surface-elevated rounded-lg p-8 text-center max-w-2xl mx-auto",children:[e.jsx("svg",{className:"w-16 h-16 mx-auto text-gray-600 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})}),e.jsx("p",{className:"text-gray-400 text-lg",children:"No cameras configured"}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Add cameras in Motion's configuration file"})]})]});const n=r.length;if(n===1){const s=r[0],N=d[s.id]||0;return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("div",{className:"max-w-5xl mx-auto",children:e.jsxs("div",{className:"bg-surface-elevated rounded-lg overflow-hidden shadow-lg","data-camera-id":s.id,children:[e.jsxs("div",{className:"px-4 py-3 border-b border-surface flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("h3",{className:"font-medium",children:s.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.width&&s.height&&e.jsxs("span",{className:"text-xs text-gray-500",children:[s.width,"x",s.height,N>0&&` @ ${N} fps`]}),e.jsx(_,{cameraId:s.id}),c==="admin"&&e.jsx(I,{cameraId:s.id,onClick:p})]})]}),e.jsx(F,{cameraId:s.id,onFpsChange:x=>h(s.id,x)})]})}),e.jsx(B,{isOpen:a,onClose:b,title:j,children:u&&e.jsx(D,{cameraId:u,config:y})})]})}const k=()=>n===2?"grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6":n<=4?"grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6":"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 sm:gap-6";return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsxs("h2",{className:"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6",children:["Cameras (",n,")"]}),e.jsx("div",{className:k(),children:r.map(s=>{const N=d[s.id]||0;return e.jsxs("div",{className:"bg-surface-elevated rounded-lg overflow-hidden shadow-lg","data-camera-id":s.id,children:[e.jsxs("div",{className:"px-4 py-3 border-b border-surface flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("h3",{className:"font-medium text-sm sm:text-base",children:s.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.width&&s.height&&e.jsxs("span",{className:"text-xs text-gray-500",children:[s.width,"x",s.height,N>0&&` @ ${N} fps`]}),e.jsx(_,{cameraId:s.id}),c==="admin"&&e.jsx(I,{cameraId:s.id,onClick:p})]})]}),e.jsx(F,{cameraId:s.id,onFpsChange:x=>h(s.id,x)})]},s.id)})}),e.jsx("p",{className:"text-center text-xs text-gray-500 mt-6",children:"Click on a camera to view fullscreen"}),e.jsx(B,{isOpen:a,onClose:b,title:j,children:u&&e.jsx(D,{cameraId:u,config:y})})]})}export{J as Dashboard};
