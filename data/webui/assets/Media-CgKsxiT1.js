import{j as e,h as ae,b as le,r as n,a as ne,o as ie,p as re,q as oe,s as ce,t as de,v as ue,g as me}from"./index-BdkU2xLT.js";function K({offset:t,limit:c,total:d,onPageChange:r,context:g}){const l=Math.floor(t/c)+1,h=Math.ceil(d/c),a=d===0?0:t+1,b=Math.min(t+c,d),i=t>0,j=t+c<d;return e.jsxs("div",{className:"flex items-center justify-between py-3 px-1",children:[e.jsxs("span",{className:"text-sm text-gray-400",children:["Displaying ",a,"-",b," of ",d,g&&e.jsxs("span",{className:"text-gray-500",children:[" ",g]})]}),h>1&&e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("button",{onClick:()=>r(Math.max(0,t-c)),disabled:!i,className:"px-3 py-1 bg-surface-elevated hover:bg-surface rounded disabled:opacity-50 disabled:cursor-not-allowed text-sm transition-colors","aria-label":"Previous page",children:"◀ Previous"}),e.jsxs("span",{className:"px-3 py-1 text-sm text-gray-400",children:["Page ",l," of ",h]}),e.jsx("button",{onClick:()=>r(t+c),disabled:!j,className:"px-3 py-1 bg-surface-elevated hover:bg-surface rounded disabled:opacity-50 disabled:cursor-not-allowed text-sm transition-colors","aria-label":"Next page",children:"Next ▶"})]})]})}function k(t){const c=me();if(!c)return t;const d=t.includes("?")?"&":"?";return`${t}${d}token=${encodeURIComponent(c)}`}const f=100;function xe(t,c){if(!t||t.length!==8)return null;const d=parseInt(t.substring(0,4),10),r=parseInt(t.substring(4,6),10)-1,g=parseInt(t.substring(6,8),10);if(isNaN(d)||isNaN(r)||isNaN(g))return null;let l=0,h=0,a=0;if(c){const i=c.split(":");i.length>=2&&(l=parseInt(i[0],10)||0,h=parseInt(i[1],10)||0,a=parseInt(i[2],10)||0)}const b=new Date(d,r,g,l,h,a);return isNaN(b.getTime())?null:b}function he(){const{addToast:t}=ae(),{role:c}=le(),d=c==="admin",[r,g]=n.useState(1),[l,h]=n.useState("pictures"),[a,b]=n.useState("all"),[i,j]=n.useState(""),[O,N]=n.useState(0),[o,w]=n.useState(null),[x,C]=n.useState(null),[v,P]=n.useState(null),y=O*f;n.useEffect(()=>{N(0)},[r,l,i]),n.useEffect(()=>{a==="all"&&j("")},[a]);const{data:Y}=ne(),{data:_,isLoading:Z}=ie(r,y,f,null,{enabled:a==="all"&&l==="pictures"}),{data:B,isLoading:J}=re(r,y,f,null,{enabled:a==="all"&&l==="movies"}),{data:u,isLoading:Q}=oe(r,i,y,f,{enabled:a==="folders"}),A=ce(),L=de(),$=ue(),F=a==="folders"?Q:l==="pictures"?Z:J,E=a==="folders"?u?.files??[]:l==="pictures"?_?.pictures??[]:B?.movies??[],D=a==="folders"?u?.total_files??0:l==="pictures"?_?.total_count??0:B?.total_count??0,T=s=>s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:s<1024*1024*1024?`${(s/(1024*1024)).toFixed(1)} MB`:`${(s/(1024*1024*1024)).toFixed(1)} GB`,V=(s,m)=>{const p=xe(s,m);return p?p.toLocaleDateString()+" "+p.toLocaleTimeString():"Unknown date"},X=n.useCallback((s,m)=>{m.stopPropagation(),C(s)},[]),ee=n.useCallback(async()=>{if(x)try{const s="type"in x?x.type:l;s==="picture"||s==="pictures"?await A.mutateAsync({camId:r,pictureId:x.id}):await L.mutateAsync({camId:r,movieId:x.id}),t(`${s==="picture"||s==="pictures"?"Picture":"Movie"} deleted`,"success"),C(null),o?.id===x.id&&w(null)}catch{t("Failed to delete file","error")}},[x,l,r,A,L,t,o]),W=n.useCallback(()=>{C(null)},[]),U=n.useCallback((s,m)=>{P({path:s,fileCount:m})},[]),se=n.useCallback(async()=>{if(v)try{const s=await $.mutateAsync({camId:r,path:v.path});t(`Deleted ${s.deleted.movies} movies, ${s.deleted.pictures} pictures`,"success"),P(null)}catch{t("Failed to delete folder contents","error")}},[v,r,$,t]),G=n.useCallback(()=>{P(null)},[]),I=n.useCallback(s=>{j(s),N(0)},[]),te=n.useCallback(()=>{u?.parent!==null&&(j(u?.parent??""),N(0))},[u]),z=A.isPending||L.isPending,S=$.isPending,H=i?i.split("/"):[];return e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsx("h2",{className:"text-3xl font-bold",children:"Media"})}),e.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"camera-select",className:"block text-sm font-medium mb-2",children:"Camera"}),e.jsx("select",{id:"camera-select",value:r,onChange:s=>g(parseInt(s.target.value)),className:"px-3 py-2 bg-surface border border-surface-elevated rounded-lg",children:Y?.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Type"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>h("pictures"),className:`px-4 py-2 rounded-lg transition-colors ${l==="pictures"?"bg-primary text-white":"bg-surface-elevated hover:bg-surface"}`,disabled:a==="folders",children:"Pictures"}),e.jsx("button",{onClick:()=>h("movies"),className:`px-4 py-2 rounded-lg transition-colors ${l==="movies"?"bg-primary text-white":"bg-surface-elevated hover:bg-surface"}`,disabled:a==="folders",children:"Movies"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"View"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>b("all"),className:`px-3 py-2 rounded-lg transition-colors text-sm ${a==="all"?"bg-primary text-white":"bg-surface-elevated hover:bg-surface"}`,children:"All"}),e.jsx("button",{onClick:()=>b("folders"),className:`px-3 py-2 rounded-lg transition-colors text-sm ${a==="folders"?"bg-primary text-white":"bg-surface-elevated hover:bg-surface"}`,children:"Folders"})]})]})]}),a==="folders"&&e.jsxs("div",{className:"mb-6 p-4 bg-surface-elevated rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("svg",{className:"w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"})}),e.jsx("span",{className:"text-sm font-medium text-gray-300",children:"Browse Folders"})]}),e.jsxs("div",{className:"flex items-center gap-1 text-sm flex-wrap",children:[e.jsx("button",{onClick:()=>I(""),className:"hover:text-primary px-1",children:"Root"}),H.map((s,m)=>{const p=H.slice(0,m+1).join("/");return e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-gray-500",children:"/"}),e.jsx("button",{onClick:()=>I(p),className:"hover:text-primary px-1",children:s})]},m)})]}),u?.parent!==null&&e.jsxs("button",{onClick:te,className:"mt-2 flex items-center gap-2 text-sm text-gray-400 hover:text-white",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),"Up to parent folder"]})]}),a==="folders"&&u&&u.folders.length>0&&e.jsx("div",{className:"mb-6 grid gap-2 md:grid-cols-2 lg:grid-cols-4",children:u.folders.map(s=>e.jsxs("div",{className:"bg-surface-elevated rounded-lg p-4 hover:ring-2 hover:ring-primary cursor-pointer transition-all group",children:[e.jsx("button",{onClick:()=>I(s.path),className:"w-full text-left",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("svg",{className:"w-8 h-8 text-yellow-500 flex-shrink-0",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:s.name}),e.jsxs("p",{className:"text-xs text-gray-400",children:[s.file_count," files - ",T(s.total_size)]})]})]})}),d&&s.file_count>0&&e.jsx("button",{onClick:m=>{m.stopPropagation(),U(s.path,s.file_count)},className:"mt-2 w-full px-2 py-1 text-xs bg-red-600/20 text-red-400 hover:bg-red-600/40 rounded opacity-0 group-hover:opacity-100 transition-opacity",title:`Delete all ${s.file_count} media files in this folder`,children:"Delete All Media"})]},s.path))}),a==="folders"&&d&&i&&u&&u.total_files>0&&e.jsx("div",{className:"mb-4 flex justify-end",children:e.jsxs("button",{onClick:()=>U(i,u.total_files),className:"px-3 py-1.5 text-sm bg-red-600/20 text-red-400 hover:bg-red-600/40 rounded-lg flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),"Delete All Media in This Folder (",u.total_files,")"]})}),!F&&D>0&&e.jsx(K,{offset:y,limit:f,total:D,onPageChange:s=>N(s/f),context:a==="folders"&&i?`in ${i}`:void 0}),F?e.jsx("div",{className:"grid gap-4 md:grid-cols-3 lg:grid-cols-4",children:[1,2,3,4,5,6,7,8].map(s=>e.jsxs("div",{className:"bg-surface-elevated rounded-lg animate-pulse",children:[e.jsx("div",{className:"aspect-video bg-surface rounded-t-lg"}),e.jsxs("div",{className:"p-3",children:[e.jsx("div",{className:"h-4 bg-surface rounded w-3/4 mb-2"}),e.jsx("div",{className:"h-3 bg-surface rounded w-1/2"})]})]},s))}):E.length===0?e.jsxs("div",{className:"bg-surface-elevated rounded-lg p-8 text-center",children:[e.jsx("p",{className:"text-gray-400",children:a==="folders"?"No media files in this folder":`No ${l} found`}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:a==="folders"?"Navigate to a folder with media files":l==="pictures"?"Motion detection snapshots will appear here":"Recorded videos will appear here"})]}):e.jsx("div",{className:"grid gap-4 md:grid-cols-3 lg:grid-cols-4",children:E.map(s=>{const m="type"in s?s.type:l==="pictures"?"picture":"movie",p="thumbnail"in s?s.thumbnail:void 0;return e.jsxs("button",{className:"bg-surface-elevated rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-primary focus:ring-2 focus:ring-primary focus:outline-none transition-all group relative text-left w-full",onClick:()=>w(s),"aria-label":`View ${s.filename}`,children:[e.jsx("button",{onClick:M=>X(s,M),className:"absolute top-2 right-2 z-10 p-1.5 bg-red-600/80 hover:bg-red-600 rounded opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity",title:"Delete","aria-label":`Delete ${s.filename}`,children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})}),e.jsxs("div",{className:"aspect-video bg-surface flex items-center justify-center relative overflow-hidden",children:[m==="picture"?e.jsx("img",{src:k(s.path),alt:s.filename,className:"w-full h-full object-cover",loading:"lazy"}):p?e.jsx("img",{src:k(p),alt:s.filename,className:"w-full h-full object-cover",loading:"lazy",onError:M=>{M.currentTarget.style.display="none";const R=M.currentTarget.parentElement;if(R){const q=R.querySelector(".fallback-icon");q&&(q.style.display="flex")}}}):null,e.jsx("div",{className:`fallback-icon text-gray-400 absolute inset-0 flex items-center justify-center ${p?"hidden":""}`,children:e.jsxs("svg",{className:"w-16 h-16",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]})})]}),e.jsxs("div",{className:"p-3",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.filename}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-400 mt-1",children:[e.jsx("span",{children:T(s.size)}),e.jsx("span",{children:s.date?V(s.date,s.time):""})]})]})]},s.id)})}),!F&&D>0&&e.jsx(K,{offset:y,limit:f,total:D,onPageChange:s=>N(s/f),context:a==="folders"&&i?`in ${i}`:void 0}),o&&e.jsx("div",{className:"fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4",onClick:()=>w(null),children:e.jsxs("div",{className:"max-w-6xl w-full bg-surface-elevated rounded-lg overflow-hidden",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b border-surface flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:o.filename}),e.jsxs("p",{className:"text-sm text-gray-400",children:[T(o.size)," ",o.date&&`- ${V(o.date,o.time)}`]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("a",{href:k(o.path),download:o.filename,className:"px-3 py-1 bg-primary hover:bg-primary-hover rounded text-sm",onClick:s=>s.stopPropagation(),children:"Download"}),e.jsx("button",{onClick:s=>{s.stopPropagation(),C(o)},className:"px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm",children:"Delete"}),e.jsx("button",{onClick:()=>w(null),className:"px-3 py-1 bg-surface hover:bg-surface-elevated rounded text-sm",children:"Close"})]})]}),e.jsx("div",{className:"p-4",children:("type"in o?o.type:l)==="picture"?e.jsx("img",{src:k(o.path),alt:o.filename,className:"w-full h-auto max-h-[70vh] object-contain"}):e.jsx("video",{src:k(o.path),controls:!0,className:"w-full h-auto max-h-[70vh]",autoPlay:!0,children:"Your browser does not support video playback."})})]})}),x&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4",onClick:W,children:e.jsx("div",{className:"w-full max-w-md bg-surface-elevated rounded-lg",onClick:s=>s.stopPropagation(),children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Delete File?"}),e.jsxs("p",{className:"text-gray-400 mb-4",children:["Are you sure you want to delete ",e.jsx("span",{className:"font-medium text-white",children:x.filename}),"? This action cannot be undone."]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:W,disabled:z,className:"px-4 py-2 bg-surface hover:bg-surface-elevated rounded-lg disabled:opacity-50",children:"Cancel"}),e.jsx("button",{onClick:ee,disabled:z,className:"px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg disabled:opacity-50",children:z?"Deleting...":"Delete"})]})]})})}),v&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4",onClick:G,children:e.jsx("div",{className:"w-full max-w-md bg-surface-elevated rounded-lg",onClick:s=>s.stopPropagation(),children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-2 text-red-400",children:"Delete All Media Files?"}),e.jsxs("p",{className:"text-gray-400 mb-4",children:["Are you sure you want to delete ",e.jsxs("span",{className:"font-medium text-white",children:["all ",v.fileCount," media files"]})," in folder ",e.jsx("span",{className:"font-mono text-primary",children:v.path||"root"}),"?"]}),e.jsx("p",{className:"text-sm text-yellow-500 mb-4",children:"This will delete movies, pictures, and their thumbnails. Subfolders will NOT be deleted. This action cannot be undone."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:G,disabled:S,className:"px-4 py-2 bg-surface hover:bg-surface-elevated rounded-lg disabled:opacity-50",children:"Cancel"}),e.jsx("button",{onClick:se,disabled:S,className:"px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg disabled:opacity-50",children:S?"Deleting...":"Delete All"})]})]})})})]})}export{he as Media};
