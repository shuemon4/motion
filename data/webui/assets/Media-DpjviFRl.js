import{h as E,r,a as F,o as W,p as q,q as H,s as R,j as e}from"./index-UPLFWLmI.js";function S(n,l){if(!n||n.length!==8)return null;const i=parseInt(n.substring(0,4),10),t=parseInt(n.substring(4,6),10)-1,c=parseInt(n.substring(6,8),10);if(isNaN(i)||isNaN(t)||isNaN(c))return null;let u=0,g=0,d=0;if(l){const a=l.split(":");a.length>=2&&(u=parseInt(a[0],10)||0,g=parseInt(a[1],10)||0,d=parseInt(a[2],10)||0)}const p=new Date(i,t,c,u,g,d);return isNaN(p.getTime())?null:p}function K(n){const l=new Map;for(const i of n){const t=S(i.date,i.time);if(!t)continue;const c=t.toISOString().split("T")[0];l.has(c)||l.set(c,[]),l.get(c).push(i)}return new Map([...l.entries()].sort((i,t)=>t[0].localeCompare(i[0])))}function U(){const{addToast:n}=E(),[l,i]=r.useState(1),[t,c]=r.useState("pictures"),[u,g]=r.useState("all"),[d,p]=r.useState(null),[a,v]=r.useState(null),[h,b]=r.useState(null),{data:T}=F(),{data:j,isLoading:$}=W(l),{data:N,isLoading:z}=q(l),y=H(),w=R(),B=t==="pictures"?$:z,f=r.useMemo(()=>t==="pictures"?j?.pictures??[]:N?.movies??[],[t,j?.pictures,N?.movies]),x=r.useMemo(()=>K(f),[f]),k=r.useMemo(()=>Array.from(x.keys()),[x]),D=r.useMemo(()=>u==="all"?f:d&&x.has(d)?x.get(d):f,[u,d,f,x]),M=s=>s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:`${(s/(1024*1024)).toFixed(1)} MB`,L=(s,o)=>{const m=S(s,o);return m?m.toLocaleDateString()+" "+m.toLocaleTimeString():"Unknown date"},A=r.useCallback((s,o)=>{o.stopPropagation(),b(s)},[]),V=r.useCallback(async()=>{if(h)try{t==="pictures"?await y.mutateAsync({camId:l,pictureId:h.id}):await w.mutateAsync({camId:l,movieId:h.id}),n(`${t==="pictures"?"Picture":"Movie"} deleted`,"success"),b(null),a?.id===h.id&&v(null)}catch{n("Failed to delete file","error")}},[h,t,l,y,w,n,a]),I=r.useCallback(()=>{b(null)},[]),C=y.isPending||w.isPending;return e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsx("h2",{className:"text-3xl font-bold",children:"Media"})}),e.jsxs("div",{className:"flex gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"camera-select",className:"block text-sm font-medium mb-2",children:"Camera"}),e.jsx("select",{id:"camera-select",value:l,onChange:s=>i(parseInt(s.target.value)),className:"px-3 py-2 bg-surface border border-surface-elevated rounded-lg",children:T?.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Type"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>c("pictures"),className:`px-4 py-2 rounded-lg transition-colors ${t==="pictures"?"bg-primary text-white":"bg-surface-elevated hover:bg-surface"}`,children:["Pictures (",j?.pictures.length===100?"100+":j?.pictures.length??0,")"]}),e.jsxs("button",{onClick:()=>c("movies"),className:`px-4 py-2 rounded-lg transition-colors ${t==="movies"?"bg-primary text-white":"bg-surface-elevated hover:bg-surface"}`,children:["Movies (",N?.movies.length===100?"100+":N?.movies.length??0,")"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"View"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{g("all"),p(null)},className:`px-3 py-2 rounded-lg transition-colors text-sm ${u==="all"?"bg-primary text-white":"bg-surface-elevated hover:bg-surface"}`,children:"All"}),e.jsxs("button",{onClick:()=>g("by-date"),className:`px-3 py-2 rounded-lg transition-colors text-sm ${u==="by-date"?"bg-primary text-white":"bg-surface-elevated hover:bg-surface"}`,children:["By Date (",k.length,")"]})]})]})]}),u==="by-date"&&k.length>0&&e.jsxs("div",{className:"mb-6 p-4 bg-surface-elevated rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("svg",{className:"w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"})}),e.jsx("span",{className:"text-sm font-medium text-gray-300",children:"Browse by Date"}),d&&e.jsx("button",{onClick:()=>p(null),className:"ml-auto text-xs text-primary hover:underline",children:"Show all dates"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:k.map(s=>{const o=x.get(s)?.length??0,m=new Date(s+"T00:00:00").toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric"});return e.jsxs("button",{onClick:()=>p(s),className:`px-3 py-1.5 rounded text-sm transition-colors ${d===s?"bg-primary text-white":"bg-surface hover:bg-surface-elevated"}`,children:[m," (",o,")"]},s)})})]}),B?e.jsx("div",{className:"grid gap-4 md:grid-cols-3 lg:grid-cols-4",children:[1,2,3,4,5,6,7,8].map(s=>e.jsxs("div",{className:"bg-surface-elevated rounded-lg animate-pulse",children:[e.jsx("div",{className:"aspect-video bg-surface rounded-t-lg"}),e.jsxs("div",{className:"p-3",children:[e.jsx("div",{className:"h-4 bg-surface rounded w-3/4 mb-2"}),e.jsx("div",{className:"h-3 bg-surface rounded w-1/2"})]})]},s))}):D.length===0?e.jsxs("div",{className:"bg-surface-elevated rounded-lg p-8 text-center",children:[e.jsxs("p",{className:"text-gray-400",children:["No ",t," found"]}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:t==="pictures"?"Motion detection snapshots will appear here":"Recorded videos will appear here"})]}):e.jsx("div",{className:"grid gap-4 md:grid-cols-3 lg:grid-cols-4",children:D.map(s=>e.jsxs("button",{className:"bg-surface-elevated rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-primary focus:ring-2 focus:ring-primary focus:outline-none transition-all group relative text-left w-full",onClick:()=>v(s),"aria-label":`View ${s.filename}`,children:[e.jsx("button",{onClick:o=>A(s,o),className:"absolute top-2 right-2 z-10 p-1.5 bg-red-600/80 hover:bg-red-600 rounded opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity",title:"Delete","aria-label":`Delete ${s.filename}`,children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})}),e.jsxs("div",{className:"aspect-video bg-surface flex items-center justify-center relative overflow-hidden",children:[t==="pictures"?e.jsx("img",{src:s.path,alt:s.filename,className:"w-full h-full object-cover",loading:"lazy"}):s.thumbnail?e.jsx("img",{src:s.thumbnail,alt:s.filename,className:"w-full h-full object-cover",loading:"lazy",onError:o=>{o.currentTarget.style.display="none";const m=o.currentTarget.parentElement;if(m){const P=m.querySelector(".fallback-icon");P&&(P.style.display="flex")}}}):null,e.jsx("div",{className:`fallback-icon text-gray-400 absolute inset-0 flex items-center justify-center ${s.thumbnail?"hidden":""}`,children:e.jsxs("svg",{className:"w-16 h-16",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]})})]}),e.jsxs("div",{className:"p-3",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.filename}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-400 mt-1",children:[e.jsx("span",{children:M(s.size)}),e.jsx("span",{children:L(s.date,s.time)})]})]})]},s.id))}),a&&e.jsx("div",{className:"fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4",onClick:()=>v(null),children:e.jsxs("div",{className:"max-w-6xl w-full bg-surface-elevated rounded-lg overflow-hidden",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b border-surface flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:a.filename}),e.jsxs("p",{className:"text-sm text-gray-400",children:[M(a.size)," â€¢ ",L(a.date,a.time)]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("a",{href:a.path,download:a.filename,className:"px-3 py-1 bg-primary hover:bg-primary-hover rounded text-sm",onClick:s=>s.stopPropagation(),children:"Download"}),e.jsx("button",{onClick:s=>{s.stopPropagation(),b(a)},className:"px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm",children:"Delete"}),e.jsx("button",{onClick:()=>v(null),className:"px-3 py-1 bg-surface hover:bg-surface-elevated rounded text-sm",children:"Close"})]})]}),e.jsx("div",{className:"p-4",children:t==="pictures"?e.jsx("img",{src:a.path,alt:a.filename,className:"w-full h-auto max-h-[70vh] object-contain"}):e.jsx("video",{src:a.path,controls:!0,className:"w-full h-auto max-h-[70vh]",autoPlay:!0,children:"Your browser does not support video playback."})})]})}),h&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4",onClick:I,children:e.jsx("div",{className:"w-full max-w-md bg-surface-elevated rounded-lg",onClick:s=>s.stopPropagation(),children:e.jsxs("div",{className:"p-6",children:[e.jsxs("h3",{className:"text-xl font-bold mb-2",children:["Delete ",t==="pictures"?"Picture":"Movie","?"]}),e.jsxs("p",{className:"text-gray-400 mb-4",children:["Are you sure you want to delete ",e.jsx("span",{className:"font-medium text-white",children:h.filename}),"? This action cannot be undone."]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:I,disabled:C,className:"px-4 py-2 bg-surface hover:bg-surface-elevated rounded-lg disabled:opacity-50",children:"Cancel"}),e.jsx("button",{onClick:V,disabled:C,className:"px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg disabled:opacity-50",children:C?"Deleting...":"Delete"})]})]})})})]})}export{U as Media};
