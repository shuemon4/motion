import{r as t,g as P,j as e,u as $,a as I,b as Y,c as U,d as W,e as z}from"./index-D07h_cnp.js";import{u as O,p as Q,a as q,C as H,F as C,b as T,c as V,A as G}from"./parameterMappings-BjW-JXSK.js";function K(a){const[c,o]=t.useState(""),[i,l]=t.useState(!0),[u,m]=t.useState(null);return t.useEffect(()=>{const x=P(),f=`/${a}/mjpg/stream`,b=x?`${f}?token=${encodeURIComponent(x)}`:f,r=new Image;return r.onload=()=>{o(b),l(!1)},r.onerror=()=>{m("Stream not available"),l(!1)},r.src=b,()=>{r.onload=null,r.onerror=null}},[a]),{streamUrl:c,isLoading:i,error:u}}function J(a){const[c,o]=t.useState(0),i=t.useRef([]),l=t.useRef(0);return t.useEffect(()=>{const u=a.current;if(!u)return;const m=()=>{const x=performance.now();i.current.push(x);const f=x-1e3;for(;i.current.length>0&&i.current[0]<f;)i.current.shift();x-l.current>=1e3&&(o(i.current.length),l.current=x)};return u.addEventListener("load",m),()=>{u.removeEventListener("load",m),i.current=[]}},[a]),c}function _({cameraId:a,className:c="",onFpsChange:o,onFullscreenRequest:i}){const{streamUrl:l,isLoading:u,error:m}=K(a),[x,f]=t.useState(!1),b=t.useRef(null),r=J(b),d=t.useRef(o);t.useLayoutEffect(()=>{d.current=o}),t.useEffect(()=>{d.current?.(r)},[r]);const v=t.useCallback(()=>{i?i():f(!0)},[i]),p=t.useCallback(g=>{g.preventDefault(),g.stopPropagation(),f(!1)},[]);return t.useEffect(()=>{if(!x)return;const g=j=>{j.key==="Escape"&&f(!1)};return document.addEventListener("keydown",g),document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",g),document.body.style.overflow=""}},[x]),m?e.jsx("div",{className:`w-full ${c}`,children:e.jsx("div",{className:"aspect-video flex items-center justify-center bg-gray-900 rounded-lg",children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("svg",{className:"w-12 h-12 mx-auto text-red-500 mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),e.jsx("p",{className:"text-red-500 text-sm",children:m})]})})}):u?e.jsx("div",{className:`w-full ${c}`,children:e.jsx("div",{className:"relative aspect-video bg-gray-900 animate-pulse rounded-lg",children:e.jsx("div",{className:"absolute top-4 right-4",children:e.jsxs("svg",{className:"w-8 h-8 text-gray-600 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})})})}):e.jsxs(e.Fragment,{children:[x&&e.jsxs("div",{className:"fixed inset-0 z-[9999] bg-black flex items-center justify-center",children:[e.jsx("button",{type:"button",onClick:p,className:"absolute top-4 right-4 z-[10000] p-3 bg-white/20 hover:bg-white/40 rounded-full transition-colors","aria-label":"Close fullscreen",children:e.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 text-white/60 text-sm",children:"Press ESC or click X to close"}),e.jsx("img",{src:l,alt:`Camera ${a} stream fullscreen`,className:"max-w-[95vw] max-h-[95vh] object-contain"})]}),e.jsx("div",{className:`w-full ${c}`,children:e.jsx("div",{className:"relative aspect-video bg-black rounded-lg overflow-hidden cursor-pointer",onClick:v,children:e.jsx("img",{ref:b,src:l,alt:`Camera ${a} stream`,className:"absolute inset-0 w-full h-full object-contain"})})})]})}function X({isOpen:a,onClose:c,sheetRef:o,closeThreshold:i=.3}){const[l,u]=t.useState(!1),[m,x]=t.useState(0),f=t.useRef(0),b=t.useRef(0),r=t.useRef(0),d=t.useRef(0),v=t.useRef(0),p=t.useCallback(h=>{u(!0),f.current=h,b.current=h,v.current=h,d.current=Date.now(),r.current=0},[]),g=t.useCallback(h=>{if(!l)return;const w=Date.now(),E=w-d.current,L=h-v.current;E>0&&(r.current=L/E),d.current=w,v.current=h,b.current=h;const S=Math.max(0,h-f.current);x(S)},[l]),j=t.useCallback(()=>{if(!l)return;u(!1);const h=o.current?.offsetHeight||400;(m>h*i||r.current>.5)&&c(),x(0),r.current=0},[l,m,c,i,o]),N=t.useCallback(h=>{const w=h.touches[0],E=o.current?.getBoundingClientRect().top||0;w.clientY-E<=60&&p(w.clientY)},[p,o]),y=t.useCallback(h=>{l&&(h.preventDefault(),g(h.touches[0].clientY))},[l,g]),n=t.useCallback(()=>{j()},[j]),s=t.useCallback(h=>{const w=o.current?.getBoundingClientRect().top||0;if(h.clientY-w<=60){p(h.clientY);const L=R=>{g(R.clientY)},S=()=>{j(),document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",S)};document.addEventListener("mousemove",L),document.addEventListener("mouseup",S)}},[p,g,j,o]),k=a?l?`translateY(${m}px)`:"translateY(0)":"translateY(100%)";return{handlers:{onTouchStart:N,onTouchMove:y,onTouchEnd:n,onMouseDown:s},style:{transform:k},state:{isDragging:l,dragOffset:m}}}function F({isOpen:a,onClose:c,title:o,children:i,headerRight:l}){const u=t.useRef(null),m=t.useRef(null),x=t.useRef(null),{handlers:f,style:b}=X({isOpen:a,onClose:c,sheetRef:u});t.useEffect(()=>{if(!a)return;const d=p=>{p.key==="Escape"&&c()},v=p=>{if(p.key!=="Tab"||!u.current)return;const g=u.current.querySelectorAll('button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'),j=g[0],N=g[g.length-1];j&&(p.shiftKey?document.activeElement===j&&(p.preventDefault(),N?.focus()):document.activeElement===N&&(p.preventDefault(),j?.focus()))};return document.addEventListener("keydown",d),document.addEventListener("keydown",v),()=>{document.removeEventListener("keydown",d),document.removeEventListener("keydown",v)}},[a,c]),t.useEffect(()=>(a?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[a]),t.useEffect(()=>{a?(x.current=document.activeElement,setTimeout(()=>{if(u.current){const d=u.current.querySelectorAll('button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');d.length>0&&d[0].focus()}},100)):x.current&&x.current.focus()},[a]);const r=t.useCallback(d=>{d.target===d.currentTarget&&c()},[c]);return a?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[100]",onClick:r,"aria-hidden":"true"}),e.jsxs("div",{ref:u,className:"fixed bottom-0 left-0 right-0 z-[101] bg-surface/95 backdrop-blur-sm rounded-t-2xl shadow-2xl transition-transform duration-300 ease-out border-t border-surface-elevated",style:{maxHeight:"45vh",transform:b.transform},role:"dialog","aria-modal":"true","aria-label":o,...f,children:[e.jsx("div",{className:"flex justify-center pt-3 pb-2 cursor-grab active:cursor-grabbing touch-none",children:e.jsx("div",{className:"w-12 h-1.5 bg-gray-500 rounded-full"})}),e.jsxs("div",{className:"flex items-center justify-between px-4 pb-3 border-b border-surface-elevated",children:[e.jsx("h2",{className:"text-lg font-semibold",children:o}),e.jsxs("div",{className:"flex items-center gap-3",children:[l,e.jsx("button",{type:"button",onClick:c,className:"p-2 hover:bg-surface-elevated rounded-full transition-colors","aria-label":"Close",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),e.jsx("div",{ref:m,className:"overflow-y-auto overscroll-contain px-4 py-4",style:{maxHeight:"calc(45vh - 80px)"},children:i})]})]}):null}function M({title:a,defaultOpen:c=!0,children:o}){const[i,l]=t.useState(c);return e.jsxs("div",{className:"mb-4",children:[e.jsxs("button",{type:"button",className:"flex items-center justify-between w-full py-2 text-left",onClick:()=>l(!i),children:[e.jsx("span",{className:"font-medium text-sm",children:a}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${i?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),i&&e.jsx("div",{className:"pt-2",children:o})]})}function A({cameraId:a,config:c}){const{mutate:o,isPending:i}=$(),[l,u]=t.useState(null),[m,x]=t.useState({}),f=t.useRef({}),{data:b}=O(a);t.useEffect(()=>()=>{Object.values(f.current).forEach(clearTimeout)},[]),t.useEffect(()=>{x({})},[c]);const r=t.useCallback((n,s="")=>n in m?m[n]:c[n]?.value??s,[c,m]);t.useEffect(()=>{Object.values(f.current).forEach(clearTimeout),f.current={}},[a]);const d=t.useCallback((n,s)=>{x(h=>({...h,[n]:s})),f.current[n]&&clearTimeout(f.current[n]);const k=a;f.current[n]=setTimeout(()=>{o({camId:k,changes:{[n]:s}},{onSuccess:()=>{u(n),setTimeout(()=>u(null),1e3)}})},300)},[a,o]),v=t.useCallback((n,s)=>{x(k=>({...k,[n]:s})),o({camId:a,changes:{[n]:s}},{onSuccess:()=>{u(n),setTimeout(()=>u(null),1e3)}})},[a,o]),p=Number(r("width",640)),g=Number(r("height",480)),j=Number(r("threshold",1500)),N=Q(j,p,g),y=t.useCallback(n=>{const s=q(n,p,g);d("threshold",s)},[p,g,d]);return e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{cameraId:a,readOnly:!0}),e.jsxs(M,{title:"Stream",defaultOpen:!0,children:[e.jsx(C,{label:"Quality",value:Number(r("stream_quality",50)),onChange:n=>d("stream_quality",n),min:1,max:100,unit:"%",helpText:"JPEG compression quality"}),e.jsx(C,{label:"Max Framerate",value:Number(r("stream_maxrate",15)),onChange:n=>d("stream_maxrate",n),min:1,max:30,unit:" fps",helpText:"Maximum stream framerate"})]}),e.jsxs(M,{title:"Image",defaultOpen:!0,children:[e.jsx(C,{label:"Brightness",value:Number(r("libcam_brightness",0)),onChange:n=>d("libcam_brightness",n),min:-1,max:1,step:.1,helpText:"Brightness adjustment"}),e.jsx(C,{label:"Contrast",value:Number(r("libcam_contrast",1)),onChange:n=>d("libcam_contrast",n),min:0,max:32,step:.5,helpText:"Contrast adjustment"}),e.jsx(C,{label:"Gain",value:Number(r("libcam_gain",1)),onChange:n=>d("libcam_gain",n),min:0,max:10,step:.1,helpText:"Analog gain (0=auto, 1.0-10.0)"}),e.jsx(T,{label:"Auto White Balance",value:!!r("libcam_awb_enable",!0),onChange:n=>v("libcam_awb_enable",n),helpText:"Enable automatic white balance"}),b?.AfMode&&e.jsxs(e.Fragment,{children:[e.jsx(V,{label:"Autofocus Mode",value:String(r("libcam_af_mode",0)),onChange:n=>v("libcam_af_mode",Number(n)),options:G.map(n=>({value:String(n.value),label:n.label})),helpText:"Focus control mode"}),Number(r("libcam_af_mode",0))===0&&b?.LensPosition&&e.jsx(C,{label:"Lens Position",value:Number(r("libcam_lens_position",0)),onChange:n=>d("libcam_lens_position",n),min:0,max:15,step:.5,unit:" dioptres",helpText:"Manual focus position (0.0-15.0 dioptres)"})]}),!b?.AfMode&&b?.LensPosition&&e.jsx(C,{label:"Lens Position",value:Number(r("libcam_lens_position",0)),onChange:n=>d("libcam_lens_position",n),min:0,max:15,step:.5,unit:" dioptres",helpText:"Manual focus position (0.0-15.0 dioptres)"})]}),e.jsxs(M,{title:"Detection",defaultOpen:!1,children:[e.jsx(C,{label:"Threshold",value:N,onChange:y,min:0,max:20,step:.1,unit:"%",helpText:"Motion sensitivity (higher = less sensitive)"}),e.jsx(C,{label:"Noise Level",value:Number(r("noise_level",32)),onChange:n=>d("noise_level",n),min:1,max:255,helpText:"Noise tolerance"}),e.jsx(T,{label:"Auto-tune Noise",value:!!r("noise_tune",!1),onChange:n=>v("noise_tune",n),helpText:"Automatically adjust noise level"})]}),i&&e.jsx("div",{className:"text-center text-sm text-gray-400 py-2",children:"Applying..."}),l&&!i&&e.jsx("div",{className:"text-center text-sm text-green-400 py-2",children:"Applied!"})]})}function B({cameraId:a}){const[c,o]=t.useState(!1),i=l=>{l.stopPropagation();const u=document.querySelector(`[data-camera-id="${a}"]`);u&&(c?document.exitFullscreen&&document.exitFullscreen():u.requestFullscreen&&u.requestFullscreen())};return t.useEffect(()=>{const l=()=>{o(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",l),()=>{document.removeEventListener("fullscreenchange",l)}},[]),e.jsx("button",{type:"button",onClick:i,className:"p-1.5 hover:bg-surface rounded-full transition-colors","aria-label":"Toggle fullscreen",title:"Toggle fullscreen",children:e.jsx("svg",{className:"w-5 h-5 text-gray-400 hover:text-gray-200",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:c?e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25"}):e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"})})})}function D({cameraId:a,onClick:c}){return e.jsx("button",{type:"button",onClick:o=>{o.stopPropagation(),c(a)},className:"p-1.5 hover:bg-surface rounded-full transition-colors","aria-label":"Quick settings",title:"Quick settings",children:e.jsxs("svg",{className:"w-5 h-5 text-gray-400 hover:text-gray-200",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})})}function te(){const{data:a,isLoading:c,error:o}=I(),{role:i}=Y(),[l,u]=t.useState(!1),[m,x]=t.useState(null),[f,b]=t.useState({}),{data:r}=U({queryKey:["config"],queryFn:async()=>{const s=await W("/0/api/config");return s.csrf_token&&z(s.csrf_token),s},enabled:l,staleTime:3e4}),d=s=>{x(s),u(!0)},v=()=>{u(!1)},p=(s,k)=>{b(h=>({...h,[s]:k}))},g=a?.find(s=>s.id===m),j=g?`Quick Settings - ${g.name}`:"Quick Settings",N=t.useMemo(()=>{if(!r||!m)return{};const s=r.configuration?.default||{},k=r.configuration?.[`cam${m}`]||{};return{...s,...k}},[r,m]);if(c)return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6",children:"Camera Dashboard"}),e.jsx("div",{className:"flex flex-col items-center gap-6",children:[1].map(s=>e.jsxs("div",{className:"bg-surface-elevated rounded-lg p-4 animate-pulse w-full max-w-4xl",children:[e.jsx("div",{className:"h-6 bg-surface rounded w-1/3 mb-4"}),e.jsx("div",{className:"aspect-video bg-surface rounded"})]},s))})]});if(o)return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6",children:"Camera Dashboard"}),e.jsxs("div",{className:"bg-danger/10 border border-danger rounded-lg p-4 max-w-2xl mx-auto",children:[e.jsxs("p",{className:"text-danger",children:["Failed to load cameras: ",o instanceof Error?o.message:"Unknown error"]}),e.jsx("button",{className:"mt-2 text-sm text-primary hover:underline",onClick:()=>window.location.reload(),children:"Retry"})]})]});if(!a||a.length===0)return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6",children:"Camera Dashboard"}),e.jsxs("div",{className:"bg-surface-elevated rounded-lg p-8 text-center max-w-2xl mx-auto",children:[e.jsx("svg",{className:"w-16 h-16 mx-auto text-gray-600 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})}),e.jsx("p",{className:"text-gray-400 text-lg",children:"No cameras configured"}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Add cameras in Motion's configuration file"})]})]});const y=a.length;if(y===1){const s=a[0],k=f[s.id]||0;return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("div",{className:"max-w-5xl mx-auto",children:e.jsxs("div",{className:"bg-surface-elevated rounded-lg overflow-hidden shadow-lg","data-camera-id":s.id,children:[e.jsxs("div",{className:"px-4 py-3 border-b border-surface flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("h3",{className:"font-medium",children:s.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.width&&s.height&&e.jsxs("span",{className:"text-xs text-gray-500",children:[s.width,"x",s.height,k>0&&` @ ${k} fps`]}),e.jsx(B,{cameraId:s.id}),i==="admin"&&e.jsx(D,{cameraId:s.id,onClick:d})]})]}),e.jsx(_,{cameraId:s.id,onFpsChange:h=>p(s.id,h)})]})}),e.jsx(F,{isOpen:l,onClose:v,title:j,children:m&&e.jsx(A,{cameraId:m,config:N})})]})}const n=()=>y===2?"grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6":y<=4?"grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6":"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 sm:gap-6";return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsxs("h2",{className:"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6",children:["Cameras (",y,")"]}),e.jsx("div",{className:n(),children:a.map(s=>{const k=f[s.id]||0;return e.jsxs("div",{className:"bg-surface-elevated rounded-lg overflow-hidden shadow-lg","data-camera-id":s.id,children:[e.jsxs("div",{className:"px-4 py-3 border-b border-surface flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("h3",{className:"font-medium text-sm sm:text-base",children:s.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.width&&s.height&&e.jsxs("span",{className:"text-xs text-gray-500",children:[s.width,"x",s.height,k>0&&` @ ${k} fps`]}),e.jsx(B,{cameraId:s.id}),i==="admin"&&e.jsx(D,{cameraId:s.id,onClick:d})]})]}),e.jsx(_,{cameraId:s.id,onFpsChange:h=>p(s.id,h)})]},s.id)})}),e.jsx("p",{className:"text-center text-xs text-gray-500 mt-6",children:"Click on a camera to view fullscreen"}),e.jsx(F,{isOpen:l,onClose:v,title:j,children:m&&e.jsx(A,{cameraId:m,config:N})})]})}export{te as Dashboard};
